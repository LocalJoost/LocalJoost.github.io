---
layout: post
title: Safe event detachment ‘pattern’ for behaviors
date: '2011-04-20T09:51:00.001+02:00'
author: Joost van Schaik
tags:
- dotnetmag
- WP7NL
- Windows Phone 7
- XAML
- behavior
- WP7
modified_time: '2011-04-21T07:58:19.795+02:00'
blogger_id: tag:blogger.com,1999:blog-5295746446529817470.post-4708791604548375425
blogger_orig_url: https://dotnetbyexample.blogspot.com/2011/04/safe-event-detachment-pattern-for.html
---

<p>For the past few weeks I’ve been hacking away at my <a href="http://www.microsoft.com/windowsphone/en-us/default.aspx" target="_blank">Windows Phone 7</a> game and noticed something odd. The objective is to intercept moving objects on the screen and drag/flick them to a target – but as the levels progressed interception and movement became ever more difficult and slow. At least that was reported by my #wp7nl fellow members who were kind (or crazy) enough to test drive the game into the higher levels. I won’t mention names here – yet ;-).</p>  <p>I followed the usual pattern for a behavior – at least, I <em>think</em> it is the usual pattern</p>  <pre>using System.Windows;
using System.Windows.Interactivity;

namespace SomeNamespace
{
  public class DemoBehavior : Behavior&lt;FrameworkElement&gt;
  {
    protected override void OnAttached()
    {
      base.OnAttached();
      AssociatedObject.Loaded += AssociatedObjectLoaded;
    }

    void AssociatedObjectLoaded(object sender, RoutedEventArgs e)
    {
      // Hook up a bunch of events to the AssociatedObject
    }

    protected override void OnDetaching()
    {
      AssociatedObject.Loaded -= AssociatedObjectLoaded;
      // Unhook the other events from the AssociatedObject
      base.OnDetaching();
    }
  }
}</pre>

<p>I had seen this problem before while programming in WPF and indeed – when I put a breakpoint in the first line of the <em>OnDetaching</em>&#160; override it was never called. Apparently Windows Phone 7 has the same problem. So here was my game, happily creating a lot of moving objects with each 1-2 behaviors attached to it listening to a bunch of events. They were never unhooked when the objects were deleted. So within a few levels the game started eating resources like there’s no tomorrow.</p>

<p>I modified my behaviors to try to do a general cleanup not only when OnDetaching is called <em>but also when the AssociatedObject is unloaded</em>. This gave me a pattern which I think might be beneficial to everyone who is working with behaviors in general:</p>

<pre>using System.Windows;
using System.Windows.Interactivity;

namespace SomeNamespace
{
  public class BetterDemoBehavior : Behavior&lt;FrameworkElement&gt;
  {
    #region Setup
    protected override void OnAttached()
    {
      base.OnAttached();
      AssociatedObject.Loaded += AssociatedObjectLoaded;
      AssociatedObject.Unloaded += AssociatedObjectUnloaded;
    }

    void AssociatedObjectLoaded(object sender, RoutedEventArgs e)
    {
      // Hook up a bunch of events to the AssociatedObject
    }
    #endregion

    #region Cleanup
    private bool _isCleanedUp;

    private void Cleanup()
    {
      if (!_isCleanedUp)
      {
        _isCleanedUp = true;
        AssociatedObject.Loaded -= AssociatedObjectLoaded;
        AssociatedObject.Unloaded -= AssociatedObjectUnloaded;
        // Unhook the other events from the AssociatedObject
      }
    }

    protected override void OnDetaching()
    {
      Cleanup();
      base.OnDetaching();
    }

    void AssociatedObjectUnloaded(object sender, RoutedEventArgs e)
    {
      Cleanup();
    }
    #endregion
  }
}</pre>

<p>And because I am not very partial to repetitive work, I created a <a href="http://www.schaikweb.net/dotnetbyexample/beh.zip" target="_blank">snippet</a> for this piece of code. </p>

<p>I guess that if both and Windows Phone 7 and WPF have this issue, Silverlight will have it as well. I hope at least this will help people who are, like me, stubborn enough to use Silverlight and <a href="http://mvvmlight.codeplex.com/" target="_blank">MVVMLight</a> to develop games for Windows Phone 7 ;-)</p>  