---
layout: post
title: Using MVVM Light to drive a Windows Phone 7 / Silverlight 4 map viewer
date: '2010-07-07T19:46:00.000+02:00'
author: Joost van Schaik
tags:
- ".NET 4.0"
- Mapping
- dotnetmag
- WP7NL
- Windows Phone 7
- Attached Dependency Property
- Architecture
- MVVM Light
- WP7
- MVVM
- Dependency Property
- Silverlight 4.0
- XAML
- Visual Studio 2010
modified_time: '2010-12-03T22:39:34.329+01:00'
thumbnail: http://lh4.ggpht.com/_QXPoKuE9q6k/TDTA_RFmAqI/AAAAAAAAFl8/Ygi5hnK_CeA/s72-c/solution_thumb.png?imgmax=800
blogger_id: tag:blogger.com,1999:blog-5295746446529817470.post-1489576144933678024
blogger_orig_url: https://dotnetbyexample.blogspot.com/2010/07/using-mvvm-light-to-drive-windows-phone.html
---

<p><em>Updated for Windows Phone 7 beta tools!</em></p>  <p>Traditionally, the first application any developer tries out on a new platform is &quot;Hello World&quot;. Working with spatial data daily, I tend to take this a wee bit more literal than most people. So when I wanted to try out MVVM and Windows Phone 7 at the same time, I went for the less-than-trivial task of making a generic <em>map viewer</em> from scratch, based upon the MultiScaleImage which – fortunately – is available on Windows Phone 7 as well. For an encore, to prove the point of MVVM, this viewer’s model should be usable by an ‘ordinary’ Silverlight application as well. My intention was to make a case study for MVVM in a less-than-ordinary environment, but I ended up with a more or less fully functional – although pretty limited – application. </p>  <p><span style="font-size: 130%">Prerequisites</span></p> This example uses:   <ol>   <li>Visual Studio 2010 Professional </li>    <li><a href="http://www.microsoft.com/downloads/details.aspx?FamilyID=c8496c2a-54d9-4b11-9491-a1bfaf32f2e3&amp;displaylang=en" target="_blank">Windows Phone 7 Developer Tools Beta</a> </li>    <li>Silverlight 4 SDK </li>    <li>Silverlight 4 tools for Visual Studio 2010 </li>    <li>The <a href="http://www.galasoft.ch/mvvm/getstarted/" target="_blank">MVVM Light framework</a> by <a href="http://twitter.com/lbugnion" target="_blank">Laurent Bugnion</a>, both for Windows Phone 7 and for Silverlight 4. The parts you need are already include in the sample. </li> </ol>  <p>On my machine I also have the Silverlight 4 Toolkit April 2010 installed as well but I don’t think that is necessary for this sample.</p>  <p><span style="font-size: 130%">Download, compile and run the source code</span></p>  <p><a href="http://lh6.ggpht.com/_QXPoKuE9q6k/TDTA-ixr1GI/AAAAAAAAFl4/gjkOMDys1nI/s1600-h/solution1.png"><img style="border-right-width: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; margin-left: 0px; border-left-width: 0px; margin-right: 0px" title="Solution structur" border="0" alt="Solution structur" align="right" src="http://lh4.ggpht.com/_QXPoKuE9q6k/TDTA_RFmAqI/AAAAAAAAFl8/Ygi5hnK_CeA/solution_thumb.png?imgmax=800" width="231" height="291" /></a>Since the application itself contains a bit more code than my usual samples (as well as a bucketload of XAML), I cannot write out all source code in the sample. In order be able to follow what is going on, you will need to <a href="http://www.schaikweb.net/dotnetbyexample/SilverMapViewer.zip" target="_blank">download the code first</a>, see if it runs and compiles on your machine, and then read the rest of this article. You will end up with a solution that, with the proper parts expanded and collapsed, will look like the solution as displayed to the right. In the Binary Dependencies solutions folder you will see Laurent’s stuff (Galasoft.*), both for Windows Phone 7 and Silverlight 4, as well as System.Windows.Interactivity, which comes from the Blend SDK. The bottom to projects, SLViewer.Web and WP7Viewer, are the actual startup projects. If you fire up one , you will get one of these screens below:</p>  <p>&#160;<a href="http://lh3.ggpht.com/_QXPoKuE9q6k/TD9M6NDL3zI/AAAAAAAAFmw/lznvYfpV7Tg/s1600-h/MobileMapLoader10.png"><img style="border-right-width: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="MobileMapLoader" border="0" alt="MobileMapLoader" src="http://lh4.ggpht.com/_QXPoKuE9q6k/TD9M6zJFTfI/AAAAAAAAFm0/9r9zP46c3c4/MobileMapLoader_thumb5.png?imgmax=800" width="208" height="358" /></a> <a href="http://lh4.ggpht.com/_QXPoKuE9q6k/TDTBCPTjUaI/AAAAAAAAFm4/d7PlUMTmu1w/s1600-h/MapLoaderSL42.png"><img style="border-right-width: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; margin-left: 0px; border-left-width: 0px; margin-right: 0px" title="Silverlight screen" border="0" alt="Silverlight screen" src="http://lh6.ggpht.com/_QXPoKuE9q6k/TDTBC3MSVsI/AAAAAAAAFnA/_ieq6-oY-_g/MapLoaderSL4_thumb2.png?imgmax=800" width="343" height="249" /></a> Now <em>that’s</em> what <em>I</em> call “Hello World”!</p>  <p><span style="font-size: 130%">Using the applications</span></p>  <p>Double-tapping (or clicking) anywhere on the map on both applications zooms in on the location of the double-tap. If you (single) tap/click on the text “Double tap zooms in” it will toggle with “Double tap zooms out” and then double tap… you guessed it.    <br />In addition, you can move the map around by dragging it – either with your finger or the mouse. By tapping/clicking on the map <em>name </em>(initially it will show the Open Source Map OsmaRender) you can change the map you are viewing: OSM OsmaRender, OSM Mapnik, Google Maps Street, Satellite, and Hybrid, and Bing Maps Road and Aerial. The Silverlight application just responds to a click and moves to the next map – the Windows Phone 7 more or less supports swipes and you can go to the next or the previous map my moving your finger from right to left or left to right over the map title. At least, it does so when I use the mouse, lacking a proper test device it is of course impossible to test how it behaves in the real world.</p>  <p><span style="font-size: 130%">Solution structure</span></p>  <p>From top to bottom you will see:</p>  <ul>   <li><strong>LocalJoost.Models</strong>, this is a Silverlight 4 class library without any content, only links to source files in LocalJoost.Model.WP7 </li>    <li><strong>LocalJoost.Model.WP7</strong>, a Windows Phone 7 class library, this contains the actual model and additional items as well as the definition of attached dependency properties needed to drive the map, </li>    <li><strong>LocalJoost.TileSource</strong>, again a codeless Silverlight class library, with links only to </li>    <li><strong>LocalJoost.TileSource.WP7</strong>, a Windows Phone 7 class library, containing classes that translate requests from the MultiScaleImage to the image structure for various <a href="http://wiki.osgeo.org/wiki/Tile_Map_Service_Specification" target="_blank">Tile Map Servers</a> </li>    <li><strong>SLViewer</strong>, the Silverlight 4 application </li>    <li><strong>SLViewer.Web</strong>, the web application hosting SLViewer </li>    <li><strong>WP7Viewer</strong>, the Windows Phone 7 application </li> </ul>  <p>Since LocalJoost.Models and LocalJoost.TileSource only contain links to source files in the Windows Phone 7 counterparts, both class libraries have identical code. </p>  <p><span style="font-size: 130%">Tile sources</span></p>  <p>MultiScaleImage features a property Source of type MultiScaleTileSource. This class sports an abstract method GetTileLayers(int tileLevel, int tilePositionX, int tilePositionY, IList&lt;object&gt;tileImageLayerSources) that you can override. Each descendant essentially tells the MultiScaleImage: if you are on zoomlevel tileLevel, and need to have the Xth horizontal tile and the Yth vertical tile, then I will add an URI to the tileImageLayerSources where you can find it. So all classes in the LocalJoost.TileSource.WP7 are simply translations from what the MultiScaleImage asks into URIs of actual map images on various map servers on the internet. Nice if you are into it (like me), but not essential to understand the workings of MVVM as a driver for this application</p>  <p><span style="font-size: 130%">Binding properties and commands</span></p>  <p>The key thing about MVVM is that <em>nothing</em>, or at least <em>very little</em>, ends up in what ASP.NET WebForms veterans like me tend to call the ‘codebehind file’ of the XAML. The idea is that you make your controls in XAML, and let them communicate by <em>binding</em> to properties and commands of the model. You click on a button or whatever, the button sends a command to the model, the model responds by changing some properties, and via the magic of <a href="http://msdn.microsoft.com/en-us/library/system.componentmodel.inotifypropertychanged.aspx" target="_blank">INotifyPropertyChanged</a> they automatically end up being displayed on the user interface. </p>  <p><u>Problem 1</u>: In Silverlight you only have events, and you cannot bind events to a model. You need <em>commands      <br /></em><u>Problem 2</u>: The MultiScaleImage control is mostly driven by <em>methods, to </em>which you cannot bind, and for some reason the Source property does not want to bind to MultiScaleTileSource either (I get an error “Object does not match target type”).</p>  <p>The solution for problem 1 is MVVM Light. The solution for problem 2 are <a href="http://localjoost.github.io/2010/05/03/attached-dependency-properties-for.html" target="_blank">attached dependency properties</a>.</p>  <p><span style="font-size: 130%">Attached dependency properties for driving the MultiScaleImage</span></p>  <p>To get this application to work, there are quite some dependency properties necessary. They are all in the class <strong>BindingHelpers</strong> in LocalJoost.Models.WP7. From top to bottom you will see:</p>  <ul>   <li><strong>MapTileSource</strong>: used to bind a MultiScaleTileSource to the Source property of a MultiScaleImage </li>    <li><strong>ZoomEventPoint</strong>: used to bind the result of an event (the location where the user tapped on the MultiScaleImage and the zoom factor) to the MultiScaleImage. </li>    <li><strong>StartDragEventData</strong>:<strong>&#160;</strong>when the user starts dragging the map, the event starting of the dragging is stored in here. Doubles as state setting: if this property is not set, the user is not dragging. The callback method of this property also stores data in the next property: </li>    <li><strong>DragData</strong>: stores the position and offset where the user started the dragging. This property is for storage only and you will not see it bound to anything in XAML. </li>    <li><strong>MoveEventData</strong>: stores the event when the user actually moves the map – in conjunction with the data stored in DragData the new map origin is calculated, and the ViewportOrigin of the MultiScaleImage gets a kick to the right place. </li> </ul>  <p><span style="font-size: 130%">Using MVVM Light to kick the model</span></p>  <p>If you look at the XAML of MainPage.xaml of WP7Viewer, there are a few things you should take notice of:</p>  <pre style="font-size: 7.8pt">&lt;phone:PhoneApplicationPage 
  x:Class=&quot;WP7Viewer.MainPage&quot;
  &lt;!--- omitted stuff ---&gt;
  xmlns:MapMvvm=&quot;clr-namespace:LocalJoost.Models;assembly=LocalJoost.Models&quot;
  xmlns:i=&quot;clr-namespace:System.Windows.Interactivity;assembly=System.Windows.Interactivity&quot;
  xmlns:cmd=&quot;clr-namespace:GalaSoft.MvvmLight.Command;assembly=GalaSoft.MvvmLight.Extras.WP7&quot;&gt;</pre>

<p>This way, I add my own assembly, with the model and the dependency property types, to be used in XAML with prefix “MapMvvm”. I also add System.Windows.Interactivity to be used with prefix “i” and MVVMLight with prefix “cmd”. And now the place where it all happens:</p>

<pre style="font-size: 9pt">&lt;MultiScaleImage x:Name=&quot;msi&quot; 
   ViewportOrigin =&quot;{Binding ViewportOrigin}&quot;
   MapMvvm:BindingHelpers.MapTileSource=&quot;{Binding CurrentTileSource.TileSource}&quot; 
   MapMvvm:BindingHelpers.ZoomEventPoint=&quot;{Binding ZoomEventPoint}&quot;
   MapMvvm:BindingHelpers.StartDragEventData=&quot;{Binding StartMoveEvent}&quot;
   MapMvvm:BindingHelpers.MoveEventData=&quot;{Binding EndMoveEvent}&quot;&gt;

 &lt;i:Interaction.Triggers&gt;
   &lt;i:EventTrigger EventName=&quot;MouseLeftButtonDown&quot;&gt;
     &lt;cmd:EventToCommand Command=&quot;{Binding MouseLeftButtonDown}&quot;
      PassEventArgsToCommand=&quot;True&quot; /&gt;
   &lt;/i:EventTrigger&gt;
   &lt;i:EventTrigger EventName=&quot;MouseLeftButtonUp&quot;&gt;
     &lt;cmd:EventToCommand Command=&quot;{Binding MouseLeftButtonUp}&quot;
      PassEventArgsToCommand=&quot;True&quot; /&gt;
    &lt;/i:EventTrigger&gt;
    &lt;i:EventTrigger EventName=&quot;MouseMove&quot;&gt;
      &lt;cmd:EventToCommand Command=&quot;{Binding MouseMove}&quot;
       PassEventArgsToCommand=&quot;True&quot; /&gt;
     &lt;/i:EventTrigger&gt;
   &lt;/i:Interaction.Triggers&gt;
&lt;/MultiScaleImage&gt;</pre>

<p>In the top part, I bind my MapTileSource, ZoomEventPoint, StartDragEventData and MoveEventData attached dependency properties of the MultiScaleImage to properties in the model, enabling the model to communicate stuff to the View – of which the MultiScaleImage is part -without having to resort to calling actual methods of the MultiScaleImage.</p>

<p>Now to enable the View to communicate <em>back</em> to the model – remember I wrote earlier that you have only events in Silverlight, no proper commands? Look at the bottom part where Laurent’s magic comes into play: I capture the <em>event</em> using an <strong>EventTrigger</strong> from System.Windows.Interactivity, and by using the <strong>EventToCommand</strong> from MVVM Light I can bind that to an <em>actual command in the model</em> – and optionally pass the parameters to the model as well. For instance, the <em>event</em> <strong>MouseLeftButtonDown</strong> is passed to the <em>command</em> <strong>MouseLeftButtonDown</strong> in MapViewModel: </p>

<pre style="font-size: 9pt">public ICommand MouseLeftButtonDown
{
  get
  {
    return new RelayCommand&lt;MouseEventArgs&gt;(e =&gt;
    {
      var t = DateTime.Now - _lastMouseDown;
      if (t &lt; _timeSpanForDoubleClick)
      {
        // assume double click - Zoom
        ZoomEventPoint = 
          new ZoomEventPoint 
           { Event = e, ZoomFactor = ZoomAction.ZoomFactor };
      }
      else
      {
        // Assume start of dragging 
        StartMoveEvent = e;
      }
      _lastMouseDown = DateTime.Now;
    });
  }
}</pre>

<p>Thus the model can communicate with the view via properties (albeit attached dependency properties) and the view can notify the model to do something by binding to its commands. The circle is closed and nothing needs to be in your ‘code behind’ file anymore. Well, almost nothing.</p>

<p><span style="font-size: 130%">Instantiating the model </span></p>

<p>A minor detail: before I can bind a view to a model, there must <em>be</em> a model to bind to. I instantiate the model in the ‘classic’ MVVM way, via XAML only. In the phone:PhoneApplicationPage.Resources I instantiate the model like this:</p>

<pre style="font-size: 9pt">&lt;phone:PhoneApplicationPage.Resources&gt;
  &lt;Storyboard x:Name=&quot;LayoutrootStartup&quot;&gt;
  &lt;!-- ommitted stuff --&gt;
  &lt;/Storyboard&gt;
  <font color="#ff0000">&lt;MapMvvm:MapViewModel x:Key=&quot;MapViewerModel&quot; /&gt;</font>
&lt;/phone:PhoneApplicationPage.Resources&gt;</pre>
The model constructor is fired, and the list of maps (_allTileSources) and zoomactions (_zoomActions) are initialized. Then I set the model as data context for the layout root: 

<pre style="font-size: 9pt">&lt;Grid x:Name=&quot;LayoutRoot&quot; 
  Background=&quot;Transparent&quot; 
    <font color="#ff0000">DataContext=&quot;{StaticResource MapViewerModel}&quot;</font>&gt;
  &lt;!-- ommitted stuff--&gt;
&lt;/Grid&gt;</pre>
and the application is off to go. There are other way of doing this: I watched <a href="http://twitter.com/dvroegop" target="_blank">Dennis Vroegop</a> once writing code instantiating the model in the constructor in the ‘code behind file’ of the user control and then setting the data context by code - this enables passing the <a href="http://msdn.microsoft.com/en-us/library/system.windows.threading.dispatcher(VS.95).aspx" target="_blank">Dispatcher</a> as a parameter which is necessary if you bind stuff coming from another thread. Dennis himself, by the way, is currently in the process of writing an excellent introduction to MVVM – the first two parts (in Dutch) you can find <a href="http://community.dotned.nl/blogs/dennis_blog/archive/2010/06/24/1063.aspx" target="_blank">here</a> and <a href="http://community.dotned.nl/blogs/dennis_blog/archive/2010/06/25/1064.aspx" target="_blank">here</a>. 

<p><span style="font-size: 130%">Implementing the ‘swipe’</span></p>

<p>As I wrote earlier, in the Windows Phone 7 application it is possible to select the next or the previous map by ‘swiping’ over the map title. There are probably better ways to do this, but I did it as follows: first, I trap the <strong>ManipulationCompleted</strong> event and pass it to the model using the same trick as before:</p>

<pre style="font-size: 9pt">&lt;TextBlock x:Name=&quot;PageTitle&quot;
  Text=&quot;{Binding CurrentTileSource.MapName}&quot; 
  Margin=&quot;-3,-8,0,0&quot;
  Style=&quot;{StaticResource PhoneTextTitle1Style&quot;&gt;
   &lt;i:Interaction.Triggers&gt;
    &lt;i:EventTrigger EventName=&quot;ManipulationCompleted&quot; &gt;
      &lt;cmd:EventToCommand Command=&quot;{Binding SetNextMapCommandWp7}&quot; 
        PassEventArgsToCommand=&quot;True&quot;/&gt;                            
    &lt;/i:EventTrigger&gt;
  &lt;/i:Interaction.Triggers&gt;
&lt;/TextBlock&gt;</pre>
and then I go on processing it like this: 

<pre style="font-size: 9pt">/// &lt;summary&gt;
/// Called by the Windows Phone client
/// when the user swipes over the map tile
/// &lt;/summary&gt;
public ICommand SetNextMapCommandWp7
{
  get
  {
    return 
      new RelayCommand&lt;ManipulationCompletedEventArgs&gt;(SetNextMapWp7);
  }
}

/// &lt;summary&gt;
/// Determine to select previous or next map
/// &lt;/summary&gt;
/// &lt;param name=&quot;e&quot;&gt;&lt;/param&gt;
public void SetNextMapWp7(ManipulationCompletedEventArgs e)
{
  if (e.TotalManipulation.Translation.X &gt; 0)
  {
    SetPreviousMap();
  }
  else
  {
    SetNextMap();
  }
}

/// &lt;summary&gt;
/// Move to the next map
/// &lt;/summary&gt;
public void SetNextMap()
{
 var currentNode = _allTileSources.Find(CurrentTileSource);
 if (currentNode != null)
 {
  CurrentTileSource =
   currentNode.Next != null ? 
    currentNode.Next.Value : _allTileSources.First.Value;
 }
}

/// &lt;summary&gt;
/// Move to the previous map
/// &lt;/summary&gt;
public void SetPreviousMap()
{
 var currentNode = _allTileSources.Find(CurrentTileSource);
 if (currentNode != null)
 {
  CurrentTileSource =
   currentNode.Previous != null ? 
     currentNode.Previous.Value : _allTileSources.Last.Value;
 }
}

/// &lt;summary&gt;
/// Command called by Silverlight 4 client
/// when user clicks on map title
/// &lt;/summary&gt;
public ICommand SetNextMapCommand
{
  get
  {
    return new RelayCommand(SetNextMap);
  }
}</pre>

<p>by checking the TotalManipulation.Translation.X property of the ManipulationCompletedEvent I can calculate if the user swiped from left to right or from right to left, thus showing the next or the previous map type. The types themselves, by the way, are stored in a LinkedList – that’s the first time I found use for <em>that</em> one – but that’s is not important for the way this works. Notice the last method – the simple SetNextCommand method – that is called by the Silverlight 4 client, where it traps a simple MouseLeftButtonDown event, which allows you only to select the next map – not the previous. ManipulationCompletedEvent seems not to be available in Silverlight 4. This is the only allowance I had to make to get the application to work from ‘plain’ Silverlight 4 as well. </p>

<p><span style="font-size: 130%">Conclusion</span></p>

<p>This application is maybe somewhat unusual and still very limited - I don’t start any story board from the model showing fancy animations (which I would like to when the user swipes over the map title to select another map, but I have not found out yet how to do that). Still, I think it’s safe to say MVVM Light used in conjunction with attached dependency properties makes it possible to bind virtually <em>anything</em>, even a MultiScaleImage, to a model. In addition, it’s possible to reuse a lot – if not all – model code by linking source files form Windows Phone 7 libraries to Silverlight 4 libraries and vice versa which makes making applications that run both on Windows Phone 7 and Silverlight 4 (and in the near future, <a href="http://www.zdnet.com/blog/microsoft/microsoft-releases-silverlight-for-symbian/6743" target="_blank">maybe even on Symbian</a>) quite feasible. All in all, from an architectural standpoint, MVVM Light and attached dependency properties are a real winning team. </p>

<p><span style="font-size: 130%">Credits, disclaimers and legal stuff</span></p>

<p>The algorithms for loading tiles from the Google servers and OSM are a slight adaptation from stuff to be found in the <a href="http://deepearth.codeplex.com/" target="_blank">DeepEarth codebase on CodePlex</a>, while the Bing algorithm actually comes from <a href="http://msdn.microsoft.com/en-us/library/bb259689.aspx" target="_blank">Microsoft itself</a>. This code loads maps directly from Google Maps and Bing Maps servers bypassing any kind of licenses, TOSses and APIs, and is in this sense probably illegal. This is done for demonstration purposes only, to show how seamlessly the MultiScaleImage works together with multiple map servers. I do by no means encourage or endorse this code to be used other than in demo settings only, and will take no responsibility for any consequences if you choose to act otherwise. So beware. If you use the Google and Bing code in production settings, don’t come knocking on my door after the map owners have come around to kick in yours. :-P</p>

<p>I nicked the algorithm for dragging the map and calculating new positions somewhere from the internet, but for the life I cannot remember where, and since I heavily refactored it for use in dependency properties <strike>Google</strike> Bing cannot find it back either. If anyone recognizes his/her code and feels I shortchanged him/her in the credits, please let me know and I will correct ASAP. </p>  