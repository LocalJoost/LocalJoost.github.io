---
layout: post
title: Keeping popups above the bottom app bar in Windows 8.1 store apps
date: '2015-01-25T15:52:00.000+01:00'
author: Joost van Schaik
tags:
- Windows phone 8.1
- Universal Apps
- XAML
- behavior
modified_time: '2015-01-27T19:00:08.204+01:00'
blogger_id: tag:blogger.com,1999:blog-5295746446529817470.post-3781059732025022038
blogger_orig_url: https://dotnetbyexample.blogspot.com/2015/01/keeping-popups-above-bottom-app-bar-in.html
---

<p>Recently, <a href="http://localjoost.github.io/2014/12/13/a-behavior-to-deal-with-ui-consequences.html" target="_blank">I wrote about the KeepFromBottomBehavior</a> that helped me to deal with popups that appeared on the bottom of the screen, but were covered by the app bar when using the full screen by applying <a href="http://localjoost.github.io/2014/10/23/making-application-bar-display-on-of.html">ApplicationViewBoundsMode.UseCoreWindow</a>. When I started porting parts of <a href="http://www.windowsphone.com/en-us/store/app/travalyzer/4314b3ed-8d77-4297-9f9e-ed576d8990b0">Travalyzer</a> to <a href="http://windows.microsoft.com/en-US/windows-8/release-preview?ocid=aff-n-we-loc--ITPRO40939&amp;WT.mc_id=aff-n-we-loc--ITPRO40939" target="_blank">Windows 8</a>.1 as a companion app, I kind of ran into the same problem: popup appearing ‘under’ the bottom app bar.</p> <p><a href="http://www.schaikweb.net/dotnetbyexample/Keeping-popups-above-the-bo.1-store-apps_13948/image.png"><img title="image" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border-top-width: 0px" border="0" alt="image" src="http://www.schaikweb.net/dotnetbyexample/Keeping-popups-above-the-bo.1-store-apps_13948/image_thumb.png" width="644" height="364"></a></p> <p>(This time I replaced the map by a simple blue area, to prevent you from needing to install the Bing Maps SDK to run the sample).</p> <p>So I kind-of ported my KeepFromBottomBehavior to Windows 8.1, and got the following result.<a href="http://www.schaikweb.net/dotnetbyexample/Keeping-popups-above-the-bo.1-store-apps_13948/image_3.png"><img title="image" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border-top-width: 0px" border="0" alt="image" src="http://www.schaikweb.net/dotnetbyexample/Keeping-popups-above-the-bo.1-store-apps_13948/image_thumb_3.png" width="644" height="364"></a></p> <p>Which is exactly what I wanted. If the App bar is open, the popup up appears above the App bar, if it is closed, it appears on the very bottom of the screen:</p> <p><a href="http://www.schaikweb.net/dotnetbyexample/Keeping-popups-above-the-bo.1-store-apps_13948/image_4.png"><img title="image" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border-top-width: 0px" border="0" alt="image" src="http://www.schaikweb.net/dotnetbyexample/Keeping-popups-above-the-bo.1-store-apps_13948/image_thumb_4.png" width="644" height="364"></a></p> <p>The code is actually a lot simpler than the KeepFromBottomBehavior for <a href="http://www.microsoft.com/windowsphone/?ocid=aff-n-we-loc--ITPRO40939&amp;WT.mc_id=aff-n-we-loc--ITPRO40939">Windows Phone</a> 8.1, </p><pre>using System.Threading.Tasks;
using Windows.UI.Xaml;
using Windows.UI.Xaml.Controls;

namespace WpWinNl.Behaviors
{
  public class KeepFromBottomBehavior : SafeBehavior&lt;FrameworkElement&gt;
  {
    private double originalBottomMargin;
    private AppBar bottomAppBar;
    protected override void OnSetup()
    {
      var page = AssociatedObject.GetVisualAncestors().OfType&lt;Page&gt;().First();
      bottomAppBar = page.BottomAppBar;
      bottomAppBar.Opened += BottomAppBarManipulated;
      bottomAppBar.Closed += BottomAppBarManipulated;
      originalBottomMargin = AssociatedObject.Margin.Bottom;
      UpdateBottomMargin();
      base.OnSetup();
    }

    void BottomAppBarManipulated(object sender, object e)
    {
      UpdateBottomMargin();
    }

    protected override void OnCleanup()
    {
      bottomAppBar.Opened -= BottomAppBarManipulated;
      bottomAppBar.Closed -= BottomAppBarManipulated;
      base.OnCleanup();
    }

    private async void UpdateBottomMargin()
    {
      await Task.Delay(1);
      var currentMargins = AssociatedObject.Margin;

      var newMargin = new Thickness(currentMargins.Left, <br>        currentMargins.Top, currentMargins.Right,
        originalBottomMargin + (bottomAppBar.IsOpen ?<br>              bottomAppBar.ActualHeight : 0));
      AssociatedObject.Margin = newMargin;
    }

    public double WindowHeight { get; set; }
  }
}</pre>
<p>Here we see this behavior works very different from it’s Windows Phone counterpart. It finds the Page this behavior is on - using the GetVisualAncestors extension methods from <a href="http://wpwinnl.codeplex.com/" target="_blank">WpWinNl</a> - and attaches itself to the bottom AppBar’s Opened and Closed events. When these events are fired, the bottom margin of the whole panel this behavior is attached to is increased with the actual height of the bottom AppBar. Easy as cake. The only weird thing is the Task.Delay(1). I found out that if you omit that, the behavior’s actions will flip-flop, that is, it won’t move the panel when you open the AppBar, but it will move it up when you <em>close</em> it. I think this has something to do with the calculation of the ActualHeight not being done yet. By using Task.Delay, with however small the value, the whole event is asynchronous and thus the calculation is not being blocked by whatever it was being blocked ;)</p>
<p>The WindowHeight is no longer a dependency property and is in fact no longer used, it’s just kept here to keep the behavior’s signature identical to it’s Windows Phone counterpart. In the sample solution you will see this behavior works stand-alone, it does not need <a href="http://localjoost.github.io/2014/04/30/a-screen-size-independent-scroll-into.html">SizeListenerBehavior</a> as a companion to bind to.</p>
<p>The <a href="https://github.com/localjoost/softwarekeysdemo" target="_blank">sample solution</a> is essentially the same <a href="http://localjoost.github.io/2014/12/13/a-behavior-to-deal-with-ui-consequences.html" target="_blank">as in the previous article</a>, but contains both code for Windows and Windows Phone now.</p>  