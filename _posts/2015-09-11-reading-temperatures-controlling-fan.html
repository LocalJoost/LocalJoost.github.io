---

title: Reading temperatures & controlling a fan with a RP2, Azure Service Bus and
  a Microsoft Band (1)
date: '2015-09-11T17:30:00.000+02:00'
orgauthor: Joost van Schaik
tags:
- UWP
- Azure
- IoT
- Raspberry PI2
- Windows 10
modified_time: '2015-09-30T20:24:13.548+02:00'
thumbnail: https://i.ytimg.com/vi/46bi9YbYckg/default.jpg
blogger_id: tag:blogger.com,1999:blog-5295746446529817470.post-208358035486958300
blogger_orig_url: https://dotnetbyexample.blogspot.com/2015/09/reading-temperatures-controlling-fan.html
---

<h4><font size="2">Part 1 - Idea, architecture, hardware shopping list and hardware configuration</font></h4> <p>Sometimes simple ideas have a tendency to balloon almost out of control, and this is one of them. In essence I wanted 'the other way around' compared with <a href="http://dotnetbyexample.blogspot.de/2015/05/using-windows-10-uwp-app-and-signalr-on.html" target="_blank">my previous IoT project</a> - in stead of using the Band as a sensor device and the Raspberry PI2 as a 'display unit', I wanted to use the Band as <em>controller. </em>The idea was I could</p> <ul> <li>Measure temperature using my Raspberry PI2 running <a href="http://www.windows.com" target="_blank">Windows</a> 10 <a href="http://ms-iot.github.io/content/en-US/GetStarted.htm" target="_blank">CoreIoT</a>  <li>See the current temperature on my Band, including the date and time it was measured  <li>Send a command to my Raspberry PI2 to switch on a fan if I find things are getting too hot  <li>See on my Band the fan has actually switched on  <li>Switch the fan off again if I feel like doing so.</li></ul> <p>Some pictures of the resulting contraption on my desk:</p> <p><a href="http://www.schaikweb.net/dotnetbyexample/Reading-temperatures--controlling-a-fan-_9EFF/IMG_2040.jpg"><img title="IMG_2040" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border-top-width: 0px" border="0" alt="IMG_2040" src="http://www.schaikweb.net/dotnetbyexample/Reading-temperatures--controlling-a-fan-_9EFF/IMG_2040_thumb.jpg" width="644" height="431"></a></p> <p><a href="http://www.schaikweb.net/dotnetbyexample/Reading-temperatures--controlling-a-fan-_9EFF/IMG_2034.jpg"><img title="IMG_2034" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border-top-width: 0px" border="0" alt="IMG_2034" src="http://www.schaikweb.net/dotnetbyexample/Reading-temperatures--controlling-a-fan-_9EFF/IMG_2034_thumb.jpg" width="644" height="431"></a></p> <p><a href="http://www.schaikweb.net/dotnetbyexample/Reading-temperatures--controlling-a-fan-_9EFF/IMG_2032.jpg"><img title="IMG_2032" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border-top-width: 0px" border="0" alt="IMG_2032" src="http://www.schaikweb.net/dotnetbyexample/Reading-temperatures--controlling-a-fan-_9EFF/IMG_2032_thumb.jpg" width="644" height="431"></a></p>I will say you this my friends: playing around with IoT stuff takes the phrase "spaghetti code" to a whole new level :D  <p><font size="4">The details<br></font>On my phone (or more precisely, the Windows 10 device to which my Band is paired) there is an app than can </p> <ul> <li>listen to temperature data coming from the Raspberry PI2,  <li>build a tile with a custom UI on my Band,  <li>listen to and act on events coming from that Band UI. </li></ul> <p>If I open the custom tile on my Band, the app on my phone gets a signal to transmit the last received data from my Raspberry PI2 (the temperature, last received update date and time, and whether the fan is on or off) to the Band, followed by a single vibrate. If I tap the fan toggle button on the custom UI on my Band, the app should respond to that as well, send back a signal over the Azure Service bus queue - and display on the Band the fan is on (and can now be switched off).</p> <p>On the Raspberry PI2 is a CoreIoT app that measures temperature and sends data over the Azure Service bus queue every five seconds, and also listens for fan switch on/off commands. It should also display it's 'health' by letting the connected two-color LED flash in green when a correct temperature is measured and transmitted, or red when something goes wrong. I also included a sequence on which the led rapidly blinks red/green to indicated the app is starting up. This is very handy when you set the app to be the default app - that way it's automatically started after the PI2 has booted Windows 10 CoreIoT and you can then see the app is actually starting up, even if there's no display connected.</p> <p>The net result you can see on this video below:</p><iframe height="362" src="https://www.youtube.com/embed/46bi9YbYckg" frameborder="0" width="645" allowfullscreen></iframe> <p>Thanks to the Azure Service Bus being ‘somewhere’ in the cloud, I can read the temperature in my study on my Band where ever I am in the world. And while that may not be the most useful thing to do, I actually have used this contraption for real when I was on holiday in Germany for the past 1.5 weeks - in stead of a fan, I connected a spotlight to it, enabling me to turn on a light at home at random times in the evening, in order to confuse potential burglars. Like I said,Windows 10 CoreIoT will always try to keep the default app running - after there's a power failure or a crash, it automatically (re)starts that app. A very useful feature when you are hundreds of kilometers from home and cannot hit a reboot button.</p> <p><font size="4">How this will be blogged</font><br>As this is quite a big project, I have decided to split the explanation into six blog posts:</p> <ol> <li>Idea, architecture, hardware shopping list and hardware configuration  <li><a href="http://localjoost.github.io/measuring-temperatures-using-uwp-on" target="_blank">Using an Azure Service Bus queue for two-way communication between IoT devices</a>  <li><a href="http://localjoost.github.io/measuring-temperatures-using-uwp-on" target="_blank">Measuring temperatures using an UWP on a Raspberry PI 2</a> <li><a href="http://localjoost.github.io/controlling-fan-using-uwp-on-raspberry" target="_blank">Controlling a fan using an UWP on a Raspberry PI2 remotely</a>  <li><a href="http://localjoost.github.io/a-windows-10-uwp-app-to-receive" target="_blank">A client app to show temperature data and control a fan</a>  <li><a href="http://localjoost.github.io/a-microsoft-band-client-to-read" target="_blank">A Microsoft Band client to read temperatures and control a fan</a></li></ol> <p>The idea I just described, so now we go on with the architecture</p> <p><font size="4">Architecture</font><br>For <a href="http://dotnetbyexample.blogspot.de/2015/05/using-windows-10-uwp-app-and-signalr-on.html" target="_blank">my previous IoT project - displaying heart rates using an LED connected to a Raspberry PI2</a> - you might recall I used an Azure hosted <a href="http://signalr.net/" target="_blank">Signal/R</a> Hub. This time, as I already said, I decided to go with a <em>queue</em> on an Azure Service Bus. Signal/R worked pretty well in the previous setup, but it has a few disadvantages:</p> <ul> <li>It requires you to deploy a web site, while the infrastructure for a Service Bus is 'hosted' by Azure itself.  <li>Signal/R signals can only be delivered real time - that is the nature of Signal/R. If you missed it, you missed it. Tough boots. A queue makes it possible to receive data for a little while after it's been sent.  <li>Security is a bit iffy - everyone who knows the address of my previous Signal/R hub solution can listen in on the data. Of course, I can encrypt that, or do access security - it's all kind of a hassle and it feels a bit roll-your-own. </li></ul> <p>There is also a disadvantage - unlike with Signal/R, there is basically only one client possible - that is the nature of a queue. If a client picks up the message, it's removed from the queue. A second client listening won't get it. So a 'broadcast' scenario is not possible. But since this is exactly what I wanted, this suited me perfectly. And my good friend <a href="http://twitter.com/qmatteoq" target="_blank">Matteo Pagani</a> from Italy had played with if before, and was kind enough to provide me with some starter code so I could go off to a flying start.</p> <p>This is a high level overview of the setup:<img title="blogplaatje" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border-top-width: 0px" border="0" alt="blogplaatje" src="http://www.schaikweb.net/dotnetbyexample/Reading-temperatures--controlling-a-fan-_9EFF/blogplaatje_thumb.png" width="644" height="296">Calling this 'architecture' is a bit rich I think, but it is intended as a global overview. Although it is not entirely correct, as this picture suggest signals go between phone and PI2 (and back) over a single channel, while in fact there are <em>two</em> queues - one for each direction. Temperature data goes from PI2 to phone over one queue, the command to toggle the fan over the other.</p> <p>Contrary to most of my demo solutions, this is a more architected solution. It uses separate components connected by dependency injection, and the Windows 10 (mobile) client is a fully fledged <a href="http://mvvmlight.codeplex.com/" target="_blank">MVVMLight</a> app. This is because I wanted to show a little more of how to do things in a more robustly architected way. It also makes it easier to split the blog post into manageable pieces. This is not just a simple demo - it's a complete setup.</p> <p>The <a href="https://github.com/LocalJoost/TemperatureReaderDemo" target="_blank">demo solution</a> contains the following projects:</p> <ul> <li>TemperatureReader - the CoreIoT UWP app running on a Raspberry PI2 that actually reads the temperature data and displays it on a screen - if one is attached, sends data over the Service Bus and waits for commands to switch the fan on or off. Or actually, just the very limited UI that bootstraps the whole process - all the logic is in  <li>TemperatureReader.Logic - contains all of the logic of reading temperature, flashing the LED and controlling the relay using the GpioController class.  <li>TemperatureReader.ClientApp is the Windows 10 UWP application that acts as intermediary between the Band and the Raspberry PI2, listening to the signals coming from the PI2 and acting on commands and/or event from the Band. It has it's own user interface to show data and initialize the Band.  <li>TemperatureReader.ServiceBus code handling communications via the Azure Service Bus.  <li>TemperatureReader.Shared - contains the data objects that are shuttled over the Service Bus, as well as a global definitions class that defines pins used on the bread board, Azure access keys, and stuff like that - because I don't like magic strings and numbers. </li></ul> <p><font size="4">Hardware shopping list</font><br>To run this project, you will need the following hardware:</p> <ul> <li>1 Raspberry PI2 running the latest Windows 10 CoreIoT build  <li>1 Microsoft Band  <li>1 device running Windows 10 (mobile or otherwise - as long as a Band can be paired to it)  <li>1 Keyes two-color Common-Cathode LED <sup>1</sup>  <li>1 Keyes Analog-temperature sensor <sup>2</sup>  <li>1 ADC0832 analog-digital-convertor <sup>3</sup><sup></sup>  <li>1 Keyes SRD-05VDC-SL-C switch <sup>4</sup>  <li>1 breadboard + flat cable connecting it to the Raspberry PI2  <li>14 connection wires (I hope I counted them correct ;) )  <li>3 barrier strip units <sup>5</sup> (<a href="http://familie.hoekstraonline.net/2015/01/15/kroonsteentjes/" target="_blank">The things we call ‘kroonsteentjes’ in Dutch</a>)  <li>1 piece of mains cord  <li>1 mains plug  <li>1 mains socket plug  <li>Some duct tape </li></ul> <p>Pictures of some assorted items:</p> <p><a href="http://www.schaikweb.net/dotnetbyexample/Reading-temperatures--controlling-a-fan-_9EFF/led.jpg"><img title="led" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border-top-width: 0px" border="0" alt="led" src="http://www.schaikweb.net/dotnetbyexample/Reading-temperatures--controlling-a-fan-_9EFF/led_thumb.jpg" width="124" height="104"></a><a href="http://www.schaikweb.net/dotnetbyexample/Reading-temperatures--controlling-a-fan-_9EFF/temperaturesensor.jpg"><img title="temperaturesensor" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border-top-width: 0px" border="0" alt="temperaturesensor" src="http://www.schaikweb.net/dotnetbyexample/Reading-temperatures--controlling-a-fan-_9EFF/temperaturesensor_thumb.jpg" width="143" height="104"></a><a href="http://www.schaikweb.net/dotnetbyexample/Reading-temperatures--controlling-a-fan-_9EFF/adconverter.jpg"><img title="adconverter" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border-top-width: 0px" border="0" alt="adconverter" src="http://www.schaikweb.net/dotnetbyexample/Reading-temperatures--controlling-a-fan-_9EFF/adconverter_thumb.jpg" width="119" height="104"></a><a href="http://www.schaikweb.net/dotnetbyexample/Reading-temperatures--controlling-a-fan-_9EFF/relay.jpg"><img title="relay" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border-top-width: 0px" border="0" alt="relay" src="http://www.schaikweb.net/dotnetbyexample/Reading-temperatures--controlling-a-fan-_9EFF/relay_thumb.jpg" width="164" height="104"></a><a href="http://www.schaikweb.net/dotnetbyexample/Reading-temperatures--controlling-a-fan-_9EFF/kroonsteentje.jpg"><img title="kroonsteentje" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border-top-width: 0px" border="0" alt="kroonsteentje" src="http://www.schaikweb.net/dotnetbyexample/Reading-temperatures--controlling-a-fan-_9EFF/kroonsteentje_thumb.jpg" width="92" height="104"></a></p> <p><font size="4">Configuration</font><br>A word of warning: the hardware configuration uses a relay switch to control <em>mains power</em>. Depending on where you live, that's between 100 and 250 Volts. We are not talking battery power here - this is the stuff that comes out of your wall plugs, drives the washing machines, refrigerators, air conditioners and whatnot, has serious oomph behind it - and can seriously hurt you if you mess around with it. In my sample I have cut a mains cord, reconnected one part via the relay and reconnected the rest using barrier strips. I sealed the connections using duct tape. At the ends of the mains cord are a mains plug and a main socket, so it can be used to control any mains power driven device. <em>Be sure that you are careful with live wires</em> and be aware that whatever I show you most likely would not get approval from a skilled electrician. If you re-create my setup with your own hardware, I cannot accept any responsibility for things going wrong. I also strongly suggest not letting the setup connected to the mains power unsupervised. This is a test/demo project, not a production unit. </p> <p><font size="3">The LED</font><br>This is an easy one. I have connected "R" to GPIO12, "Y" to GPIO16, and "G" to GND (of course).</p> <p><font size="3">The SRD-05VDC-SL-C switch <br></font>A bit more complicated, as the are no markings on the pins of this device. If you hold it the way that you can read the text on the blue block and the pins are sticking out to the right (as in picture 4) I have connected the top pin to GND, the middle pin to 5V,&nbsp; and the bottom pin to GPIO18.</p> <p>On the <em>other side</em>, the part with the screws on it - I connected the mains wire. I cut this first, then reconnected to mains using three terminal strip units - an sealed the stuff with duct tape. As already stated - follow this advice at your own risk. Basically one wire goes straight trough, the other part goes through the switch. Now it's not easy to see, but if you hold the switch like displayed on picture 4 (and below), you will see screws on the left side, and you&nbsp; can just about read "NO" under the top screw, and "NC" under the bottom screw. This stands for "Normal Open" and "Normal Closed". You fix one of the mains wire to the NO screw, and the other under the <em>middle</em> screw. </p> <p><a href="http://www.schaikweb.net/dotnetbyexample/Reading-temperatures--controlling-a-fan-_9EFF/image.png"><img title="image" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; float: right; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border-top-width: 0px" border="0" alt="image" src="http://www.schaikweb.net/dotnetbyexample/Reading-temperatures--controlling-a-fan-_9EFF/image_thumb.png" width="216" align="right" height="204"></a><a href="http://www.schaikweb.net/dotnetbyexample/Reading-temperatures--controlling-a-fan-_9EFF/image_3.png"><img title="image" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border-top-width: 0px" border="0" alt="image" src="http://www.schaikweb.net/dotnetbyexample/Reading-temperatures--controlling-a-fan-_9EFF/image_thumb_3.png" width="333" height="204"></a></p> <p><font size="3">The Analog temperature sensor</font><br>I have connected the middle pin to 3.3V, the "-" pin to GND, and "S" pin to 2 of the AC-converter (see below). That converter is the hardest part.</p> <p><font size="3">The ADC0832 analog-digital-convertor</font> <br>I'll be the first one to admit that I actually have no idea how this works, I nicked the idea from the Sunfounders manual. I understand the principle of an A/D converter, I just have no idea why it needs to be connected in this specific way, and I understand even less of the programming 'sequence' (that will be described in a later post) <a href="http://www.schaikweb.net/dotnetbyexample/Reading-temperatures--controlling-a-fan-_9EFF/image_4.png"><img title="image" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; float: right; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border-top-width: 0px" border="0" alt="image" src="http://www.schaikweb.net/dotnetbyexample/Reading-temperatures--controlling-a-fan-_9EFF/image_thumb_4.png" width="197" align="right" height="244"></a>that goes into it. Anyway, this A/D converter is a chip and if you hold it the way that you can actually read the text on it, the pins are numbered this way. Why? I really don't know, having no formal background in electronics. Now this pins also have labels attached to them which are:</p> <p>1 = CS<br>2 = CH0<br>3 = CH1<br>4 = GND<br>5 = DI<br>6 = DO<br>7 = CLK<br>8 = VCC</p> <p>These names we will see back later in <a href="https://github.com/LocalJoost/TemperatureReaderDemo" target="_blank">the sample</a> solution. So, more or less following lead of the Sunfounders manual, I made the following connections</p> <ul> <li>1 to GPIO5  <li>2 to the "S" pin of the Analog temperature sensor  <li>3 to nothing  <li>4 to GND  <li>8 to 3.3V  <li>7 to GPIO6  <li>5 <em>and</em> 6 to GPIO13</li></ul> <p><font size="4">Running the sample solution</font><br>If you want to run the <a href="https://github.com/LocalJoost/TemperatureReaderDemo" target="_blank">sample solution</a>, you will at least need to</p> <ul> <li>Create an Azure Service bus  <li>Paste the key into Settings.cs in TemperatureReader.Shared  <li>Deploy the TemperatureReader app on a Raspberry PI2 running Windows 10 CoreIoT with all the named hardware attached  <li>Deploy the TemperatureReader.ClientApp to a Windows 10 device with a Microsoft Band to it.</li></ul> <p>The next episode in this series will explain how the <a href="http://localjoost.github.io/using-azure-service-bus-queue-for-two" target="_blank">Azure Service bus is utilized as an IoT communication conduit</a>. </p>  