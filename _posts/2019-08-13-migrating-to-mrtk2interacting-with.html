---
layout: post
title: Migrating to MRTK2–interacting with the Spatial Map
date: '2019-08-13T11:45:00.000+02:00'
orgauthor: Joost van Schaik
tags:
- HoloLens
- Unity
- Windows Mixed Reality
- MRTK2
- HoloLens2
modified_time: '2019-08-13T11:45:26.804+02:00'
thumbnail: https://i.ytimg.com/vi/GpPNK1AHrBg/default.jpg
blogger_id: tag:blogger.com,1999:blog-5295746446529817470.post-8926506343654336437
blogger_orig_url: https://dotnetbyexample.blogspot.com/2019/08/migrating-to-mrtk2interacting-with.html
comment_issue_id: 337
---

<h2>Intro</h2><p>One of the HoloLens’ great features is the ability to interact with real physical objects. This allows apps to place holograms on or adjacent to real objects, enables occlusion (the ability to let holograms appear to be hidden because they disappear behind physical objects), etc. This is all done using the Spatial Map, a graphical representation of whatever the HoloLens has observed to be present in the physical reality. Interacting with the Spatial map used to be easy – and it actually still isn't that hard, it’s just that - as with most of the things in the <a href="https://github.com/microsoft/MixedRealityToolkit-Unity" target="_blank">MRTK2</a> - quite some cheese has been moved </p><p>This blog post handles a common and a not so common scenario for interacting with the Spatial Map:</p><ol><li>Placing objects on the Spatial Map</li><li>Programmatically enabling and disabling/clearing the Spatial Map</li></ol><p>I have included a <a href="https://github.com/LocalJoost/SpatialMapInteraction" target="_blank">demo project</a> that allows you to place cylinders on the Spatial Map by air tapping - and you can turn the Spatial Map on and off using a floating button.</p><h2>Placing objects on the Spatial Map, MRKT2 style</h2><p>I wrote about this already in <a href="https://localjoost.github.io/finding-floor-and-displaying-holograms" target="_blank">November 2017</a> in my article about finding the floor using a HoloLens. In <a href="https://github.com/microsoft/MixedRealityToolkit-Unity" target="_blank">MRTK2</a>, that process is a bit much different. Create a raycast from the Camera along the camera viewing angle and try to hit the Spatial Map. For this, you need the Spatial Map Layer mask. In the HoloToolkit you could simply access. </p><pre>SpatialMappingManager.Instance.LayerMask</pre><p>to get to that layer mask. Finding that now is a <em>wee</em> bit more complicated. You see, first, you need to extract the configuration from the Spatial Awareness System service like this: </p><pre>var spatialMappingConfig =<br>      CoreServices.SpatialAwarenessSystem.ConfigurationProfile as<br>&nbsp;&nbsp;&nbsp;&nbsp; MixedRealitySpatialAwarenessMeshObserverProfile;</pre><p>The spatial mapping config contains<em>&nbsp;</em>a property called ObserverConfigurations containing a <em>list</em> of of configurations (apparently taking provisions there might actually be more than one configuration). For each configuration you can take the profile from it's ObserverProfile property - that you have to cast to MixedRealitySpatialAwarenessMeshObserverProfile. Then you find the layer used by this config in it's MeshPhysicsLayer property.</p><p>I repeat - <em>you can find the <strong>layer</strong>. </em></p><p><em>That is not the layer <strong>mask</strong>. </em>It took me <em>quite</em> some time debugging to find out what was going on here - because if you feed that layer <em>number </em>into the raycast, it won't 'see' the Spatial Map. I have no idea why this was changed. Anyway, to get the layer <em>mask, </em>as required by raycast methods,<em>&nbsp;</em>you have to <em>bit shift</em> the actual layer <em>number</em>, like this</p><pre>1 &lt;&lt; observerProfile.MeshPhysicsLayer</pre><p>So what used to be a single property, now requires this method:</p><pre>private static int GetSpatialMeshMask()
{
    if (_meshPhysicsLayer == 0)
    {
        var spatialMappingConfig = 
          CoreServices.SpatialAwarenessSystem.ConfigurationProfile as
            MixedRealitySpatialAwarenessSystemProfile;
        if (spatialMappingConfig != null)
        {
            foreach (var config in spatialMappingConfig.ObserverConfigurations)
            {
                var observerProfile = config.ObserverProfile
                    as MixedRealitySpatialAwarenessMeshObserverProfile;
                if (observerProfile != null)
                {
                    _meshPhysicsLayer |= (1 &lt;&lt; observerProfile.MeshPhysicsLayer);
                }
            }
        }
    }

    return _meshPhysicsLayer;
}

private static int _meshPhysicsLayer = 0;</pre><p>And I added a static backing variable to speed up this process, otherwise this whole loop will be run 60 times a second in my <a href="https://github.com/LocalJoost/SpatialMapInteraction/blob/master/Assets/App/Scripts/TapToPlaceController.cs" target="_blank">TapToPlaceController</a>, as well as every time you air tap to place a cylinder.</p><p>The method to find a point on the Spatial Map simply is then simply this:</p><pre>public static Vector3? GetPositionOnSpatialMap(float maxDistance = 2)
{
    RaycastHit hitInfo;
    var transform = CameraCache.Main.transform;
    var headRay = new Ray(transform.position, transform.forward);
    if (Physics.Raycast(headRay, out hitInfo, maxDistance, GetSpatialMeshMask()))
    {
        return hitInfo.point;
    }
    return null;
}</pre><p>This sits in the updated <a href="https://github.com/LocalJoost/SpatialMapInteraction/blob/master/Assets/MRTKExtensions/Utilities/LookingDirectionHelpers.cs" target="_blank">LookingDirectionHelpers</a> class. In the <a href="https://github.com/LocalJoost/SpatialMapInteraction" target="_blank">demo project</a> you can see how it is actually used. </p><p>In the <a href="https://github.com/LocalJoost/SpatialMapInteraction/blob/master/Assets/App/Scripts/TapToPlaceController.cs" target="_blank">TapToPlaceController</a>, the Update method will flip the text from “Please look at the spatial map max 2m ahead of you" to "Tap to select a location" when the gaze strikes the Spatial Map (and the Spatial Map ONLY, not another hologram).</p><pre>protected override void Update()<br>{<br>&nbsp;&nbsp;&nbsp; _instructionTextMesh.text = <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; LookingDirectionHelpers.GetPositionOnSpatialMap(_maxDistance) != null ? <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "Tap to select a location" : _lookAtSurfaceText;<br>
}</pre><p>If you then air tap, it will place a squatted cylinder on the spatial map at the place you are looking to. This is done in the OnPointerDown method - using the same call to LookingDirectionHelpers.GetPositionOnSpatialMap to get a point to place the cylinder.</p><p>You will notice a floating cube as well. You can't place a cylinder on the cube - it only finds the Spatial Map. Demonstrating that you can't place a cylinder on it, is the cube's sole purpose ;). What might happen is that you place a cylinder <em>behind the cube on the Spatial Map</em>, if your opposite wall is closer than 2 meters. It requires additional logic to handle that situation, but that is beyond the scope of this blog post. </p><h2>Starting, stopping and clearing the Spatial map</h2><p>For some apps, most notably my <a href="https://www.microsoft.com/store/productId/9NBLGGH52SZP" target="_blank">AMS HoloATC</a> app, the Spatial Map is used to help getting an initial place to put an object but then it needs to go away, as to not get the view blocked by occlusion. Making the Spatial Map transparent sometimes helps, but then still the walls get in the way of selecting objects as they block the gaze and other cursors. Long story short – it is sometimes desirable to be able to turn the Spatial map on and off. And this is actually pretty simple:<br><br></p><pre>public void ToggleSpatialMap()<br>{    <br>&nbsp;&nbsp;&nbsp;&nbsp; if( CoreServices.SpatialAwarenessSystem != null)<br>&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if( IsObserverRunning )<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; CoreServices.SpatialAwarenessSystem.SuspendObservers();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; CoreServices.SpatialAwarenessSystem.ClearObservations();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; CoreServices.SpatialAwarenessSystem.ResumeObservers();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp; }<br>}</pre><p>Note that “ClearObservations” is necessary, as merely calling Suspend only stops the <em>updating</em> of the Spatial Map – the graphic representation still stays active. This was actually added after feedback from yours truly ;)</p><p>As to checking whether or not the observer is / observers are actually running I have devised this little trick</p><pre>private bool IsObserverRunning<br>{<br>&nbsp;&nbsp;&nbsp;&nbsp; get<br>&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; var providers = <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ((IMixedRealityDataProviderAccess)CoreServices.SpatialAwarenessSystem)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; .GetDataProviders&lt;IMixedRealitySpatialAwarenessObserver&gt;();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return providers.FirstOrDefault()?.IsRunning == true;<br>&nbsp;&nbsp;&nbsp;&nbsp; }<br>}</pre><p><img width="100" height="99" align="right" style="border: 0px currentcolor; border-image: none; float: right; display: inline; background-image: none;" src="https://www.schaikweb.net/blog/20190813/Button.png" border="0">I check if there’s an observer and assume that if the first one is running, so is probably the rest. Although in practice, on a HoloLens, there will be only one observer running anyway.</p><p>You can activate and de-activate the Spatial Map by pressing the floating button, where <a href="https://github.com/LocalJoost/SpatialMapInteraction/blob/master/Assets/App/Scripts/SpatialMapToggler.cs" target="_blank">the SpatialMapToggler</a> behaviour is attached to.</p><h2>Conclusion</h2><p>If you run and deploy the <a href="https://github.com/LocalJoost/SpatialMapInteraction" target="_blank">demo project</a> you will find a button floating before you (in the direction that you looked when the app started) that you can use to toggle the Spatial Map, and to the right a little cube. In addition, a text floating in your vision instructs you either to look at the spatial map or air tap when you actually do – and then a cylinder will appear. Like this in this little video:</p><iframe width="650" height="365" src="https://www.youtube.com/embed/GpPNK1AHrBg" frameborder="0" allowfullscreen="" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture"></iframe>
