---
layout: post
title: 'Sharepoint Client Object Model: sites, roles, lists, documents, AD users and permissions'
date: '2011-03-01T20:53:00.005+01:00'
orgauthor: Joost van Schaik
tags:
- Active Directory
- Sharepoint
- dotnetmag
- Client Object Model
- Sharepoint 2010
modified_time: '2012-03-04T10:32:52.755+01:00'
blogger_id: tag:blogger.com,1999:blog-5295746446529817470.post-6348836171416028330
blogger_orig_url: https://dotnetbyexample.blogspot.com/2011/03/sharepoint-client-object-model-sites.html
comment_issue_id: 73
---

<p>Recently I had my very first encounter with <a href="http://sharepoint.microsoft.com/en-us/pages/default.aspx?ocid=aff-n-we-loc--ITPRO40939&WT.mc_id=aff-n-we-loc--ITPRO40939" target="_blank">Sharepoint</a>, and I cannot say it was a pleasant meeting. I was doing a proof of concept for a customer to manipulate Sharepoint from code using the new Sharepoint 2010 Client Object Model. Not that this is a particular unpleasant job in itself and neither is the API particulary bad (although <em>definitely </em>odd), but the <a href="http://msdn.microsoft.com/en-us/library/ee537247.aspx?ocid=aff-n-we-loc--ITPRO40939&WT.mc_id=aff-n-we-loc--ITPRO40939" target="_blank">MSDN documentation</a> about the Client Object Model is far from self-explanatory, and lacks the – for me, at last –&#160; most crucial part of educational material: simple how-to examples. </p>  <p>Most examples found elsewhere are either based on older API’s, incomplete and sometimes completely wrong. And you have to roam about half the internet to get pieces of code together. So I thought it would be a good idea to cobble together pieces from the POC into a comprehensive blog post with what I’ve learned, hoping to save other people the same quest. </p>  <p>Be aware that I learned this all just in the past few days so things are pretty crude at times. I am by no means a Sharepoint wizard - nor am I planning on becoming one :-).&#160; The idea is just to show how it’s done. I think there are a lot of people out there who know how to do things better and more efficient than me: it just <em>they</em> don’t blog about it ;-)</p>  <p>This code was used to talk to a Sharepoint foundation on a domain controller outside the domain on which I actually <em>ran </em>the code.</p>  <p><font size="4">Things covered in this post</font></p>  <ul>   <li>Create a site </li>    <li>Retrieve a site by title </li>    <li>Retrieve a role by Role type </li>    <li>Retrieve a Sharepoint principal by Active Directory <em>user or group name</em> </li>    <li>Retrieve a document library by name </li>    <li>Retrieve a document library <em>template</em> by name </li>    <li>Create a document library and set permissions </li>    <li>Create a folder in a document library </li>    <li>Upload a file to a document library </li>    <li>Download a file from a document library </li>    <li>List all folders or files in a document library </li> </ul>  <p><font size="4">Setting the stage</font></p>  <p>It started out making a “Sharepointhelper” class. The basics of this thing is a follows:</p>  <pre>using System;
using System.Collections.Generic;
using System.IO;
using System.Linq;
using System.Net;
using System.Reflection;
using System.Security.Principal;
using System.Text;
using Microsoft.SharePoint.Client;
using Microsoft.SharePoint.Client.Utilities;
using File = Microsoft.SharePoint.Client.File;

namespace TestSharepoint
{
  public class SharepointHelper
  {
    private ClientContext clientContext;
    private Web rootWeb;

    public SharepointHelper(string url, string username, string password)
    {
      clientContext = new ClientContext(url);
      var credentials = new NetworkCredential(username, password, &quot;domain&quot;);
      clientContext.Credentials = credentials;
      rootWeb = clientContext.Web;
      clientContext.Load(rootWeb);
    }
  }
}</pre>

<p>Creating the object should go like this:</p>

<pre>var sh = new SharepointHelper(&quot;http://yourserver&quot;, &quot;aUser&quot;, &quot;hisPassword&quot;);</pre>

<p>aUser must be a user with enough rights to perform sharepoint administration. I used the domain admin username and password and I assure you – <em>that </em>works ;-)</p>

<p><font size="4">Create a site</font></p>

<pre>public void CreateSite(string siteDescription, string siteTitle, string siteUrl)
{
  rootWeb = rootWeb.Webs.Add(new WebCreationInformation
    {
      Description = siteDescription,
      Title = siteTitle,
      Url = siteUrl,
      UseSamePermissionsAsParentSite = false
    });
  clientContext.ExecuteQuery();
}</pre>
Usage sample:&#160; <pre>sh.Create(&quot;My site description&quot;, &quot;MySite&quot;, &quot;mysiteurl&quot;);</pre>

<p><font size="4">Retrieve a site by title</font></p>

<pre>public Web GetWebByTitle(string siteTitle)
{
  var query = clientContext.LoadQuery(
    rootWeb.Webs.Where(p =&gt; p.Title == siteTitle));
  clientContext.ExecuteQuery();
  return query.FirstOrDefault();
}</pre>
Usage sample:&#160; <pre>var w = sh.GetWebByTitle(&quot;MySite&quot;);</pre>

<p><font size="4">Retrieve role by Role type</font></p>

<pre>private RoleDefinition GetRole(string siteTitle, RoleType rType)
{
  var web = GetWebByTitle(siteTitle);
  if (web != null)
  {
    var roleDefs = web.RoleDefinitions;
    var query = clientContext.LoadQuery(
        roleDefs.Where(p =&gt; p.RoleTypeKind == rType));
    clientContext.ExecuteQuery();
    return query.FirstOrDefault();
  }
  return null;
}</pre>
Usage sample:&#160; <pre>var r = sh.GetRole(&quot;MySite&quot;, RoleType.Contributor);</pre>
will get you the contributor role. 

<p><font size="4">Retrieve a Sharepoint principal by Active Directory user or group name </font></p>
Now this one took me a very long time. For some reason there is a static Utility.SearchPrincipals method that gets you a PrincipalInfo object, but you can never get to get a Principal object that you can use for setting permissions. I spent a long time scratching my head how to get around this before I found there is another way: 

<pre>public Principal GetPrincipal(string name)
{
  if (web != null)
  {
    try
    {
      var principal = web.EnsureUser(name);
      clientContext.Load(principal);
      clientContext.ExecuteQuery();
      if (principal != null)
      {
        return principal;
      }
    }
    catch (ServerException){}
  }
  return null;
}</pre>
Usage sample:&#160; <pre>var g = sh.GetPrincipal(&quot;MyUserGroup&quot;);
var u = sh.GetPrincipal(&quot;MyUser&quot;);</pre>

<p>This will, as you can see, get you either a user group’s principal or a single user’s principal. Since I was looking for a <em>group’s</em> principal it never occurred to me to try the “EnsureUser” method. If you don’t know what a Principal is – neither do I (at least not exactly) but I of think it as a descriptor of a user’s or group's credentials.</p>

<p><font size="4">Retrieve a document library by name </font></p>

<pre>public List GetDocumentLibrary(string siteTitle, string libraryName)
{
  var web = GetWebByTitle(siteTitle);
  if (web != null)
  {
    var query = clientContext.LoadQuery(
         web.Lists.Where(p =&gt; p.Title == libraryName));
    clientContext.ExecuteQuery();
    return query.FirstOrDefault();
  }
  return null;
}</pre>
Usage sample:&#160; <pre>var g = GetDocumentLibrary(&quot;MySite&quot;, &quot;myDocumentLibrary&quot;);</pre>

<p><font size="4">Retrieve a document library template by name</font></p>

<pre>public ListTemplate GetDocumentLibraryTemplate(Web web, string name)
{
  ListTemplateCollection ltc = web.ListTemplates;
  var listTemplates = clientContext.LoadQuery(
    ltc.Where(p =&gt; p.InternalName == name));
  clientContext.Load(ltc);
  clientContext.ExecuteQuery();
  return listTemplates.FirstOrDefault();
}</pre>
Usage sample:&#160; <pre>var t = sh.GetDocumentLibraryTemplate(web, &quot;doclib&quot;);</pre>
This will get you the template for the document library type. 

<p><font size="4">Create a document library and set permissions</font></p>

<p>Now this was what I actually had to prove in the POC, and you can see this as it uses a lot of the previous samples: </p>

<pre>public bool CreateDocumentLibrary(string siteTitle, string libraryName, 
                                  string libraryDescription, string userGroup)
{
  var web = GetWebByTitle(siteTitle);
  if (web != null)
  {
    // First load all the list
    var lists = web.Lists;
    clientContext.Load(lists);
    clientContext.ExecuteQuery();

    // Create new lib based upon the doclib template
    var newList = lists.Add(new ListCreationInformation
      {
        Title = libraryName,
        Description = libraryDescription,
        TemplateType = 
          GetDocumentLibraryTemplate(web, &quot;doclib&quot;).ListTemplateTypeKind
      });
    clientContext.ExecuteQuery();

    // Override default permission inheritance
    newList.BreakRoleInheritance(true, false);
    // Get principal for usergroup and the contributor role
    var principal = GetPrincipal(userGroup);
    var role = GetRole(siteTitle, RoleType.Contributor);
    
    // Add the role to the collection.
    var collRdb = new RoleDefinitionBindingCollection(clientContext) {role};
    var collRoleAssign = newList.RoleAssignments;
    collRoleAssign.Add(principal, collRdb);

    clientContext.ExecuteQuery();
    
    return true;
  }
  return false;
}</pre>
Usage sample:&#160; <pre>var result = sh.CreateDocumentLibrary(&quot;MySite&quot;, &quot;myDocumentLibrary&quot;,
                                      &quot;A very nice library&quot;, &quot;MyUserGroup&quot;);</pre>

<p>Which will create a document library “myDocumentLibrary” in “MySite” with a contributor role for “MyUserGroup”. Like I said, it’s pretty crude still here and there, but you get the idea</p>

<p><font size="4">Create a folder in a document library</font></p>

<pre>public void CreateFolder( string siteTitle, string libraryName, string folder)
{
  var list = GetDocumentLibrary(siteTitle, libraryName);
  if (list != null)
  {
    var folders = list.RootFolder.Folders;
    clientContext.Load(folders);
    clientContext.ExecuteQuery();
    var newFolder = folders.Add(folder);
    clientContext.ExecuteQuery();
  }
}</pre>
I'll skip the usage sample here, as I suppose it's pretty self-explanatory now. 

<p><font size="4">Upload a file to a document library </font></p>

<pre>public void UploadDocument( string siteTitle, string libraryName, string fileName )
{
  var web = GetWebByTitle(siteTitle);
  var fInfo = new FileInfo(fileName);
  var targetLocation = string.Format(&quot;{0}/{1}/{2}&quot;, web.ServerRelativeUrl, 
     libraryName, fInfo.Name);
  
  using (var fs = new FileStream(fileName, FileMode.Open))
  {
    File.SaveBinaryDirect(clientContext, targetLocation, fs, true);
  }
}</pre>
Usage sample:&#160; <pre>var result = sh.UploadDocument(&quot;MySite&quot;, &quot;myDocumentLibrary&quot;,
                              @&quot;c:\temp\sample.png&quot;);</pre>
This will upload the file c:\temp\sample.png as &quot;sample.png&quot; in the &quot;myDocumentLibrary&quot; library. 

<p><font size="4">Download a file from a document library </font></p>

<p>What goes up must come down, eh? This one is a bit odd, as it strips the directory name of the target file and tries to find the file in Sharepoint with it, but it works, so what:</p>

<pre>public void DownloadDocument(string siteTitle, string libraryName, 
                             string fileName)
{
  var web = GetWebByTitle(siteTitle);
  var fInfo = new FileInfo(fileName);

  var source = string.Format(&quot;{0}/{1}/{2}&quot;, web.ServerRelativeUrl, 
                                            libraryName, fInfo.Name);
  var spFileInfo = File.OpenBinaryDirect(clientContext, source);
  using (var fs = new FileStream(fileName, FileMode.OpenOrCreate))
  {
    spFileInfo.Stream.CopyTo(fs);
  }
}</pre>
Usage sample:&#160; <pre>sh.DownloadDocument(&quot;MySite&quot;, &quot;myDocumentLibrary&quot;,
                     @&quot;c:\temp\sample.png&quot;);</pre>
will search for the file &quot;sample.png&quot; in &quot;myDocumentLibrary&quot; and try to download that to c:\temp 

<p><font size="4">Listing files or folders in a document library </font></p>

<p>And finally:</p>

<pre>public List&lt;File&gt; ListFiles(string siteTitle, string libraryName)
{
  var list = GetDocumentLibrary(siteTitle, libraryName);
  var files = list.RootFolder.Files;
  clientContext.Load(files);
  clientContext.ExecuteQuery();
  return files.ToList();
}

public List&lt;Folder&gt; ListFolders(string siteTitle, string libraryName)
{
  var list = GetDocumentLibrary(siteTitle, libraryName);
  var folders = list.RootFolder.Folders;
  clientContext.Load(folders);
  clientContext.ExecuteQuery();
  return folders.ToList();
}</pre>

<p>and if you don’t mind, I’ll skip the usage samples here as well.</p>
