---
layout: post
title: Unit testing async Windows Phone 8 code on the UI thread with VS 2012.2 CTP4
date: '2013-03-21T20:38:00.001+01:00'
author: Joost van Schaik
tags:
- Windows Phone 8
- wpnl
- wpdev
- dotnetmag
- Unit Test
modified_time: '2013-03-26T13:04:11.142+01:00'
blogger_id: tag:blogger.com,1999:blog-5295746446529817470.post-5106540278545062181
blogger_orig_url: https://dotnetbyexample.blogspot.com/2013/03/unit-testing-async-windows-phone-8-code.html
---

<p><a href="http://www.schaikweb.net/dotnetbyexample/Unit-testing-async-Windows-Phone-8-code-_1129E/image.png"><img title="image" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; float: right; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border-top-width: 0px" border="0" alt="image" align="right" src="http://www.schaikweb.net/dotnetbyexample/Unit-testing-async-Windows-Phone-8-code-_1129E/image_thumb.png" width="468" height="341"></a>This may be the most cryptic acronym-laden title I ever used for a blog post, but it quite exactly describes what I was trying to do yesterday. </p> <p>The <a href="http://blogs.msdn.com/b/visualstudioalm/archive/2013/03/04/march-ctp-of-visual-studio-update-2.aspx" target="_blank">Visual Studio 2012 CTP4</a> makes it possible to write real <a href="http://www.microsoft.com/windowsphone/?ocid=aff-n-we-loc--ITPRO40939&amp;WT.mc_id=aff-n-we-loc--ITPRO40939" target="_blank">Windows Phone</a> 8 unit tests that run in the Visual Studio Unit Test runner (in stead of only on the emulator). So when I wanted to investigate the Routing API that is new in Windows Phone 8, I decided not to write an application outright, but start out with unit test.</p> <p>I set up a new solution with two projects, as I usually do: one with the actual app - and one class library with the view models, models and other logic in it that isnot directly related to the user interface. And then I added a Windows Phone 8 Unit Test App. </p> <p>First things first: when I want to test routing, I first need to give the user an option to select a location to go to. I decided to use the Geocoding API. I decided the view model should contain the following:</p> <ul> <li>A string property SearchText to be filled by the user  <li>An ObservableCollection of MapLocation called MapLocations to be filled by the Geocoder, intended to be bound to a list control of some kind to enable the user to select on of the founds locations.  <li>A MapLocation property SelectedLocation to hold the MapLocation selected by the user  <li>A little method to actually perform the geocoding  <li>A command wrapping this method.</li></ul> <p>My good and very smart friend - and fellow Phone development MVP - <a href="http://www.twitter.com/qmatteoq" target="_blank">Matteo Pagani</a> has already covered some ground in this direction by <a href="http://wp.qmatteoq.com/unit-testing-in-windows-phone-8-asynchronous-operations-and-mocking/" target="_blank">writing this article</a> and inspired by it I decided to pull in the Microsoft.Bcl.Async library as well so I could use async/await, on the premises that you can never have too much beta software in your project ;-)</p> <p>The method I wanted to test was pretty simple:</p><pre>public async Task SearchLocation()
{
  MapLocations.Clear();
  SelectedLocation = null;
  var geoCoder = new GeocodeQuery { <br>    SearchTerm = SearchText, 
    GeoCoordinate = new GeoCoordinate() };
  MapLocations.AddRange(await geoCoder.GetMapLocationsAsync());
}</pre>
<p>And so was the test method – I let it search for the street I live in.</p><pre>[TestMethod]
public async Task TestLocationWrong1()
{
  var testVm = new GeocodeViewModel
    {SearchText = "Springerstraat Amersfoort Netherlands"};
  await testVm.SearchLocation();
  Assert.IsTrue(testVm.MapLocations.Any());
}</pre>
<p><a href="http://www.schaikweb.net/dotnetbyexample/Unit-testing-async-Windows-Phone-8-code-_1129E/image_3.png"><img title="image" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; float: right; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border-top-width: 0px" border="0" alt="image" align="right" src="http://www.schaikweb.net/dotnetbyexample/Unit-testing-async-Windows-Phone-8-code-_1129E/image_thumb_3.png" width="157" height="195"></a>I ran the test…. and was quite surprised by the result. “Invalid cross thread access"??? I don’t even <em>have</em> a UI. Very interesting. Apparently the GeocodeQuery needs to be run on the UI thread. As to why this is, I have no idea. Some people (hi Morten ;-) ) say that if you have to unit test on the UI thread, you are doing it wrong. That may be the case, but it seems I have little choice here and&nbsp; I still want to test my view model.</p>
<p>According to <a href="http://blogs.msdn.com/b/visualstudioalm/archive/2013/01/30/first-ctp-for-visual-studio-update-2.aspx" target="_blank">this page</a> there is a UITestMethodAttribute for Windows Store applications to solve this kind of problems – but not for Windows Phone 8 (yet) so obviously I had to pull in the Dispatcher. Since calling stuff from the Dispatcher runs asynchronously as well take 2 didn’t work of course…</p><pre>[TestMethod]
public void TestLocationWrong2()
{
  var testVm = new GeocodeViewModel 
  { SearchText = "Springerstraat Amersfoort Netherlands" };
  Deployment.Current.Dispatcher.BeginInvoke(async () =&gt; await testVm.SearchLocation());
  Assert.IsTrue(testVm.MapLocations.Any());
}</pre>
<p>…for the simple reason that the although testVM.SearchLocation is now fired on the UI thread, the Assert is not, and it is executed directly after the BeginInvoke is called and MapLocations still is empty when the Assert is evaluated.</p>
<p>I don’t know if there’s a smarter way to do this, but I used an AutoResetEvent to solve it. I used that to block the test thread until the UI thread is done, like this:</p><pre>[TestMethod]
public void TestLocationSearchHasResult()
{
  var waitHandle = new <font color="#ff0000">AutoResetEvent(false)</font>;
  var testVm = new GeocodeViewModel { SearchText = "Springerstraat Amersfoort Netherlands" };
  Deployment.Current.Dispatcher.BeginInvoke(async () =&gt;
    {
      await testVm.SearchLocation();
      <font color="#ff0000">waitHandle.Set();</font>
    });
  <font color="#ff0000">waitHandle.WaitOne(TimeSpan.FromSeconds(5));</font>
  Assert.IsTrue(testVm.MapLocations.Any());
}</pre>
<p><a href="http://www.schaikweb.net/dotnetbyexample/Unit-testing-async-Windows-Phone-8-code-_1129E/image_4.png"><img title="image" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; float: left; padding-top: 0px; padding-left: 0px; margin: 0px 10px 0px 0px; display: inline; padding-right: 0px; border-top-width: 0px" border="0" alt="image" align="left" src="http://www.schaikweb.net/dotnetbyexample/Unit-testing-async-Windows-Phone-8-code-_1129E/image_thumb_4.png" width="204" height="119"></a></p>
<p>The test thread waits until waitHandle.Set() is called – or five seconds, whatever happens first – and <em>then</em> it performs the Assert. And that works.</p>
<p>As usual, you can <a href="http://schaikweb.net/dotnetbyexample/NavigationTest.zip" target="_blank">download a demo solution here</a>. It was actually meant to be a solution demoing the Route API, as stated earlier, but I thought this subject deserved a blog post on its own.</p>
<p>As stated, this project requires installation of the <a href="http://blogs.msdn.com/b/visualstudioalm/archive/2013/03/04/march-ctp-of-visual-studio-update-2.aspx" target="_blank">Visual Studio 2012 CTP4</a>. This has a GoLive license, but it’s still preview software. Install it on your own risk.</p>
<p><strong>Update</strong>: Pedro Lamas, a Windows Phone Development specialist working for Nokia, <a href="http://www.pedrolamas.com/2013/03/25/windows-phone-8-unit-testing-in-the-ui-thread-with-vs-2012-2-ctp4/" target="_blank">has posted about his port of UITestMethodAttribute to Windows Phone</a>. That runs the <em>whole</em> test on the UI thread in stead of only the the mandatory part. This brute-force method may not be desirable for all cases, but it sure is pretty easy to use. </p>  