---
layout: post
title: ".NET Native, SilverlightSerializer, MakeGenericType and MissingMetadataException"
date: '2016-03-23T17:06:00.001+01:00'
orgauthor: Joost van Schaik
tags:
- UWP
- reflection
- ".NET Native"
- Generics
- Serialization
modified_time: '2016-03-23T17:20:00.932+01:00'
blogger_id: tag:blogger.com,1999:blog-5295746446529817470.post-2283582183645255438
blogger_orig_url: https://dotnetbyexample.blogspot.com/2016/03/net-native-silverlightserializer.html
comment_issue_id: 242
---

<p>Recently I have ported my app <a href="https://www.microsoft.com/en-US/store/Apps/Map-Mania-8/9NBLGGH08D4P" target="_blank">Map Mania</a> to the&nbsp; <a href="https://www.visualstudio.com/en-us/features/universal-windows-platform-vs.aspx">Universal Windows Platform</a>, and at the moment of this writing it is being certified. (that, I least I hope). It’s the first UWP app I actually submit to the Store. I have been doing quite some <a href="https://dev.windows.com/en-US/iot" target="_blank">IoT Core</a> stuff and that does not require much submitting. But it had to happen at one time, if only to dogfood my <a href="https://github.com/LocalJoost/WpWinNl/tree/uwp" target="_blank">WpWinNl</a> port to UWP, and it was an educating experience.</p> <p>I learned the hard way that stuff that does work with debug settings, does not necessarily work when you compile stuff ‘for real’. I ran into quite a serious issue with generics. As soon as I turned my app over to the .NET Native toolchain, it even crashed on startup. Mind you, most of the ‘business code’ in this app and large parts of the XAML were still the same as the original Windows Phone7 and 8 app, as was the WpWinNl base library – all ported to UWP, but largely unchanged.</p> <p>The root cause of the problem turned out to be SilverlightSerializer. This is a serialization framework made by <a href="http://twitter.com/mike_talbot" target="_blank">Mike Talbot</a> that I have been using to store app state since 2011. It’s name quite dates it origins. Unfortunately the <a href="http://whydoidoit.com/2010/04/08/silverlight-serialization/" target="_blank">link to the original article</a> is dead – actually the whole blog seems to have disappeared - but it’s code has been sitting in WpWinNl and it’s predecessors ever since that time. I have ported it to Windows Phone 8, Windows RT, and now to UWP. </p> <p>Deep down in the core it uses the <a href="https://msdn.microsoft.com/en-us/library/system.type.makegenerictype%28v=vs.110%29.aspx" target="_blank">Type.MakeGenericType</a> method to make a generic type with two type parameters to store types. So if I have ViewModel with a double property, it makes a <strong>GetSetGeneric&lt;ViewModel, double&gt;</strong>. This, now, does not go down well with .NET Native. Runtime, it will pop up the following error:</p> <p><strong>Exception thrown: 'System.Reflection.MissingMetadataException' in System.Private.CoreLib.dll</strong></p> <p><strong>Additional information: Reflection_InsufficientMetadata_EdbNeeded: WpWinNl.Utilities.GetSetGeneric&lt;BeautyOfMaps.Models.TileMapSource,System.Boolean&gt;. For more information, visit http://go.microsoft.com/fwlink/?LinkId=623485</strong></p> <p>Now, in your app, in&nbsp; the “Properties” folder, there is a Default.rd.xml file that allows you to instruct the compiler not to ‘optimize things away’, to make sure this code still works. The insidious part is that this code is <em>in my libary</em>, downloaded from NuGet, and since it uses generics there is no ‘'generic’ way for me to instruct the compiler in the <em>libary’s</em> rd.xml <em>not</em> to optimize away code in the <em>app</em> <em>that is using it</em>.</p> <p>If I wanted to fix this particular problem, I have to add the following line to the app’s rd.xml:</p><pre>&lt;Type Name="WpWinNl.Utilities.GetSetGeneric{BeautyOfMaps.Models.ViewModel.MainViewModel,System.Boolean}" Dynamic="Required All"/&gt;</pre>
<p>And guess what – then you get the <em>next</em> error. Now it it’s complaining about missing </p>
<p><strong>WpWinNl.Utilities.GetSetGeneric&lt;LocalJoost.Maps.TileSources.Google,<br>LocalJoost.Maps.TileSources.GoogleType&gt;</strong> </p>
<p>So it apparently needs a line like this <em>for every class type and property type combination</em> that goes past MakeGenericType. So while you already defined <em>in code</em> what these properties are, you have to declare (again) in XML which ones you want to keep. I have been in contact with the .NET Native team about the apparent lack of logic behind this, but is seems that according to their date very little people actually use this kind of reflection. While this is true without any doubt – Microsoft telemetry does not lie - I think the critical thinking error that was made here is that <em>those people might be using libraries that do</em> – like mine! - and then they are thoroughly in deep… er, manure. </p>
<p>Trying to add manually all class/property type combinations is where madness lies, my friends. I came to about the 6th type and then I was kind of done. I am a developer, so I am lazy by nature, and in stead of actually doing it manually I added a weird property to SilverlightSerializer called RdXmlEntries. It’s usage is as follows:</p>
<ul>
<li>Run the app in DEBUG (so not .NET Native) 
<li>Serialize all objects you want to serialize 
<li>Directly behind the last serialization, add this code:</li></ul><pre>foreach (var entry in SilverlightSerializer.RdXmlEntries)
{
  Debug.WriteLine(entry);
}</pre>
<ul>
<li>Copy and paste the resulting data in your Default.rd.xml </li>
<li>Verify your code now runs under .NET Native.</li></ul>
<p>This code is now in <a href="https://www.nuget.org/packages/WpWinNlBasic/3.0.5-alpha" target="_blank">WpWinNlBasic version 3.0.5-alpha on NuGet</a> and available for use. You now know why I keep this in the unstable branch – as long as I haven’t had the chance to dogfood <em>all</em> the stuff I have ported and created earlier, I want to thread carefully.</p>
<p>When I showed this solution to the .NET Native team I got feedback that I only needed to provide lines for when the second parameter is a<em> value</em> type, not when it’s a reference type. I have validated that in one case, but I serialize quite a complicated object graph and had spent more than enough time on it already, I did not really feel like experimenting further.</p>
<p>Bottom line – be very, very careful with advanced reflection in UWP apps. Don’t make the same mistake I made – test early under .NET Native and follow <a href="https://blogs.msdn.microsoft.com/visualstudioalm/2015/07/29/debugging-net-native-windows-universal-apps/" target="_blank">guidance provided here</a> to maintain your sanity.</p>
<p>Special thanks to <a href="http://twitter.com/tomverhoeff" target="_blank">Tom Verhoeff</a> for providing assistance based upon his earlier experience. And sorry, no code sample this time as this is more general guidance that a specific coding issue ;)</p>
