---
layout: post
title: Writing behaviors in PCL for Windows Phone 8.1 and Windows 8.1
date: '2014-05-06T21:38:00.001+02:00'
orgauthor: Joost van Schaik
tags:
- Windows phone 8.1
- PCL
- Windows 8
- behavior
- Universal App
modified_time: '2014-05-08T20:58:37.665+02:00'
blogger_id: tag:blogger.com,1999:blog-5295746446529817470.post-1242023790167880472
blogger_orig_url: https://dotnetbyexample.blogspot.com/2014/05/writing-behaviors-in-pcl-for-windows.html
---

<p><em>This article was updated after a tip from <a href="https://twitter.com/dsplaisted">Daniel Plaisted</a> – see comments</em></p> <p>I was happily adding <a href="http://www.microsoft.com/windowsphone/?ocid=aff-n-we-loc--ITPRO40939&amp;WT.mc_id=aff-n-we-loc--ITPRO40939" target="_blank">Windows Phone</a> 8.1 support to <a href="http://WpWinNl.codeplex.com" target="_blank">WpWinNl</a> – or actually support for Universal Windows Apps - when I noticed that basically all I was doing was linking files from the Windows 8.1 project – without any changes. Convergence FTW! Although that made adding the support as such pretty simple, I also envisioned a maintenance nightmare coming towards me as would not only need to maintain links between Windows 8.1 and Windows Phone 8.0, but also between Windows 8.1 and Windows Phone 8.1. Maybe it was time to go PCL. That went pretty well, until I hit a major roadblock. </p> <p>This roadblock, my friends, is very simple: the behaviors SDK, and thus everything in <strong>Microsoft.Xaml.Interactivity</strong>, is not available to PCL. This has probably to do with the fact that the behaviors SDK for Windows 8 is a separate entity, not part of the core framework, that was added later. This same characteristic has moved over to Windows Phone 8.1. It basically boils down to this: every behavior must implement <strong>Microsoft.Xaml.Interactivity.IBehavior</strong> and this is sitting in two separate assemblies – one for Windows, one for Windows Phone. On my Surface Pro they are sitting in C:\Program Files (x86)\Microsoft SDKs\Windows\v8.1\ExtensionSDKs\BehaviorsXamlSDKManaged\12.0\ for Windows 8.1 and in C:\Program Files (x86)\Microsoft SDKs\WindowsPhoneApp\v8.1\ExtensionSDKs\BehaviorsXamlSDKManaged\12.0\ for Windows Phone 8.1</p> <p>Now what?</p> <p>Of course, like I wrote before, you can moan and complain about this and send venomous tweets to Joe Belfiore, Cliff Simpkins or just the first Windows Phone MVP you can find – or you can pause and think if there’s a way around it. This is the thing I love to do – explore, thinker, invent – and come to a solution. Because as it turns out, my friends, there is one.</p> <p><a href="http://www.schaikweb.net/dotnetbyexample/1a96ec6b72c4_10590/image_11.png"><img title="image" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; float: left; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border-top-width: 0px" border="0" alt="image" src="http://www.schaikweb.net/dotnetbyexample/1a96ec6b72c4_10590/image_thumb_11.png" width="304" align="left" height="266"></a>The key to the solution is <a href="http://log.paulbetts.org/the-bait-and-switch-pcl-trick/" target="_blank">this pretty odd article</a> that, believe it or not, was sent to a closed mailing list of Windows Phone MVPs to collect opinions on – by none other than <a href="http://www.twitter.com/mahoekst" target="_blank">Matthijs Hoekstra</a>, just the day before I wrote this. Then I thought it was a crazy idea - today I find it an invaluable clue. Talking about coincidences. It’s like basic research – you never know where the next life saving idea will be coming from ;-) .</p> <p>It’s called the <a href="http://log.paulbetts.org/the-bait-and-switch-pcl-trick/">“Bait and switch PCL trick”</a> and it basically makes use of a very odd NuGet trick – it will always prefer a native platform library over a PCL. If you make a NuGet package that contains <em>both a PCL and a native version</em>, the PCL is then only used at<em> compile time</em>. So what I did was create this crazy NuGet package called CrossPlatformBehaviorBase (I think I am going to change that later) that basically has three projects in it: once PCL, one Windows Phone 8.1, and one Windows 8.1.</p> <p>The key thing is that the implementation for Windows Phone and Windows are the same (in fact, the Windows Phone 8.1 implementation is linked from the Windows implementation, but the PCL is slightly different. The PCL version is a copy of the normal IBehavior interface, namespace and all:<pre>using Windows.UI.Xaml;

namespace Microsoft.Xaml.Interactivity
{
  public interface IBehavior
  {
    DependencyObject AssociatedObject { get; }

    void Attach(DependencyObject associatedObject);

    void Detach();
  }
}</pre>
<p>Whereas the Windows Phone and Windows implementations look like this:</p><pre>[assembly: System.Runtime.CompilerServices.TypeForwardedTo(<br>  typeof(Microsoft.Xaml.Interactivity.IBehavior))]
</pre>
<p>Indeed, that is all. A <a href="http://msdn.microsoft.com/en-us/library/system.runtime.compilerservices.typeforwardedtoattribute.aspx">type forwarding statement</a> to convince the compiler to look for the right IBehavior at runtime. I did not know this trick, but <a href="https://twitter.com/dsplaisted">Daniel Plaisted</a> alerted me in the comments.</p>
<p><a href="http://www.schaikweb.net/dotnetbyexample/1a96ec6b72c4_10590/image_3.png"><img title="image" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; float: right; padding-top: 0px; padding-left: 0px; margin-left: 0px; display: inline; padding-right: 0px; border-top-width: 0px; margin-right: 0px" border="0" alt="image" src="http://www.schaikweb.net/dotnetbyexample/1a96ec6b72c4_10590/image_thumb_3.png" width="404" align="right" height="134"></a>If you build for release this will create three projects neatly conforming to NuGet naming specifications and finally run a little command file that creates a NuGet package in the output folder directly under the solution folder.</p>
<p>To be able to install the package, you need to specify that folder as a NuGet source:</p>
<p><a href="http://www.schaikweb.net/dotnetbyexample/1a96ec6b72c4_10590/image_4.png"><img title="image" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border-top-width: 0px" border="0" alt="image" src="http://www.schaikweb.net/dotnetbyexample/1a96ec6b72c4_10590/image_thumb_4.png" width="644" height="437"></a></p>
<p><a href="http://www.schaikweb.net/dotnetbyexample/1a96ec6b72c4_10590/image_5.png"><img title="image" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; float: right; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border-top-width: 0px" border="0" alt="image" src="http://www.schaikweb.net/dotnetbyexample/1a96ec6b72c4_10590/image_thumb_5.png" width="244" align="right" height="96"></a>Mind you, in the future this will all be on NuGet so you won’t have to put up with this. For now,&nbsp; am just explaining how it’s done.</p>
<p>Anyway, I went ahead and created an Universal Windows App DemoApp, and added a Windows Phone 8.1/Windows 8.1 PCL “WpWinNl” to the solution.</p>
<p>The newly created NuGet package needs to be installed in all three projects:&nbsp; </p>
<p><a href="http://www.schaikweb.net/dotnetbyexample/1a96ec6b72c4_10590/image_6.png"><img title="image" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; float: none; padding-top: 0px; padding-left: 0px; margin-left: auto; display: block; padding-right: 0px; border-top-width: 0px; margin-right: auto" border="0" alt="image" src="http://www.schaikweb.net/dotnetbyexample/1a96ec6b72c4_10590/image_thumb_6.png" width="304" height="304"></a>And then I started in copying stuff from WpWinNl,starting with the <a href="http://dotnetbyexample.blogspot.nl/2013/10/introducing-win8nl-for-windows.html">Behavior base class that I created to maintain compatibility with ‘Silverlight style’ behaviors</a>:</p><pre>using Windows.UI.Xaml;

namespace WpWinNl.Behaviors
{
  public abstract class Behavior : DependencyObject, <font color="#000000">IBehavior</font>
  {
    public DependencyObject AssociatedObject { get; set; }

    public virtual void Attach(DependencyObject associatedObject)
    {
      AssociatedObject = associatedObject;
    }

    public virtual void Detach()
    {
    }
  }
}</pre>
<p>This will compile fine, now I have the replacement IBehavior in the PCL version. We continue with the Behavior&lt;T&gt; which of course compiles as well:</p><pre>namespace WpWinNl.Behaviors
{
  public abstract class Behavior&lt;T&gt; : Behavior where T: DependencyObject
  {
    [System.ComponentModel.EditorBrowsable(
       System.ComponentModel.EditorBrowsableState.Never)]
    public new T AssociatedObject { get; set; }

    public override void Attach(DependencyObject associatedObject)
    {
      base.Attach(associatedObject);
      this.AssociatedObject = (T)associatedObject;
      OnAttached();
    }

    public override  void Detach()
    {
      base.Detach();
      OnDetaching();
    }

    protected virtual void OnAttached()
    {
    }

    protected virtual void OnDetaching()
    {
    }
  }
}</pre>
<p><a href="http://www.schaikweb.net/dotnetbyexample/1a96ec6b72c4_10590/image_7.png"><img title="image" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; float: right; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border-top-width: 0px" border="0" alt="image" src="http://www.schaikweb.net/dotnetbyexample/1a96ec6b72c4_10590/image_thumb_7.png" width="354" align="right" height="371"></a>Which basically comes over from the existing <a href="http://WpWinNl.codeplex.com" target="_blank">WpWinNl</a> implementation <em>unchanged</em>. For kickers, I then put my infamous <a href="http://dotnetbyexample.blogspot.nl/2012/04/porting-dragflickbehavior-from-windows.html">DragFlickBehavior</a>, and <a href="http://dotnetbyexample.blogspot.nl/2011/03/simple-windows-phone-7-silverlight.html">all my animation code</a> that has been featured on this blog multiple times on top of it and lo and behold – with a minor addition it just works. And I was able to delete all #ifdef statements for Windows Phone out, leaving only the former ‘just windows’ code. <em>All in PCL</em>. And all usable both on Windows Phone and Windows.</p>
<p><a href="http://www.schaikweb.net/dotnetbyexample/1a96ec6b72c4_10590/image_8.png"><img title="image" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border-top-width: 0px" border="0" alt="image" src="http://www.schaikweb.net/dotnetbyexample/1a96ec6b72c4_10590/image_thumb_8.png" width="254" height="234"></a><br>As coupe de grace I put the whole of MainPage.xaml in the shared portion, opened Blend and sure enough – there was my DragFlickBehavior: </p>
<p>So I dropped a date picker, a text box and a button on the screen and dragged my PCL-DragFlickBehavior on top on all three:</p><pre>&lt;Page
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    
    xmlns:Interactivity="using:Microsoft.Xaml.Interactivity"
    xmlns:behaviors="using:WpWinNl.Behaviors"

    x:Class="DemoApp.MainPage"
    mc:Ignorable="d"&gt;

  &lt;Grid Background="{ThemeResource ApplicationPageBackgroundThemeBrush}"&gt;
    &lt;Button Content="Button" HorizontalAlignment="Left" Height="37" 
      Margin="101,114,0,0" VerticalAlignment="Top" Width="108"&gt;
      &lt;Interactivity:Interaction.Behaviors&gt;
        &lt;behaviors:DragFlickBehavior/&gt;
      &lt;/Interactivity:Interaction.Behaviors&gt;
    &lt;/Button&gt;
    &lt;DatePicker HorizontalAlignment="Left" Margin="48,230,0,0"<br>                VerticalAlignment="Top"&gt;
      &lt;Interactivity:Interaction.Behaviors&gt;
        &lt;behaviors:DragFlickBehavior/&gt;
      &lt;/Interactivity:Interaction.Behaviors&gt;
    &lt;/DatePicker&gt;
    &lt;TextBlock HorizontalAlignment="Left" Height="42" Margin="132,310,0,0" 
        TextWrapping="Wrap" Text="Blabla" VerticalAlignment="Top" Width="121"&gt;
      &lt;Interactivity:Interaction.Behaviors&gt;
        &lt;behaviors:DragFlickBehavior/&gt;
      &lt;/Interactivity:Interaction.Behaviors&gt;
    &lt;/TextBlock &gt;
  &lt;/Grid&gt;
&lt;/Page&gt;
</pre>
<p>And sure enough:<a href="http://www.schaikweb.net/dotnetbyexample/1a96ec6b72c4_10590/image_9.png"><img title="image" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; float: left; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border-top-width: 0px" border="0" alt="image" src="http://www.schaikweb.net/dotnetbyexample/1a96ec6b72c4_10590/image_thumb_9.png" width="170" align="left" height="280"></a><a href="http://www.schaikweb.net/dotnetbyexample/1a96ec6b72c4_10590/image_10.png"><img title="image" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; float: left; padding-top: 0px; padding-left: 0px; margin: 0px 0px 0px 9px; display: inline; padding-right: 0px; border-top-width: 0px" border="0" alt="image" src="http://www.schaikweb.net/dotnetbyexample/1a96ec6b72c4_10590/image_thumb_10.png" width="454" align="left" height="280"></a></p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>The screen shows up and you can happily drag the items along, although dragging a Windows Phone date picker is quite a challenge.</p>
<p>So there you have it – behaviors completely defined in PCL, courtesy of a little NuGet trick. Could the Windows Phone and/or Windows Team have done this themselves? Possibly – but don’t forget I just sailed past anything that is not managed, like C++. And if there ain’t any challenges for MVPs to meet, fat lot of use we would be, eh? ;-)</p>
<p>A zip file with both the NuGet package and the Universal Windows App <a href="http://www.schaikweb.net/dotnetbyexample/CrossPlatformBehaviors.zip">can be found here</a>. For now it’s a kind of proof of concept, soon I will be putting this NuGet package out on NuGet itself and use it for the new version of WpWinNl. After some rigorous testing ;). </p>
<p>Update – after some thinking I decided to call this IBehaviorPortable <a href="http://www.nuget.org/packages/IBehaviorPortable">and have uploaded it to NuGet</a> with that name.</p>  